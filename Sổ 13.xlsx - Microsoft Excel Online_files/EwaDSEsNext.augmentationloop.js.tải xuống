'use strict';(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[15],{1161:function(u,F,a){function c(Fa){return L.Range.Qc(Fa.row+1,Fa.col+1)}var b=a(9);u=a(0);var e=a(15),f=a(694),d=a(49),h=a(37),n=a(1284),m=a(238),x=a(21),r=a(247),y=a(259),t=a(12),v=a(92),w=a(1);class C extends m.a{constructor(Fa){super(document.createElement("div"));this.hyj=oa=>{this.wk=oa};this.$=Fa;this.grid=x.h(Fa)}static init(Fa){C.Ma?e.ULS.sendTraceTag(522782307,1,15,"FormulaSuggestionUIControl.init: unexpected call after already being inited."):
C.Ma=new C(Fa)}static instance(){return C.Ma}get Hf(){return null!=this.wk}get de(){return r.a.DZe}get mc(){return this.wk}kg(Fa,oa){oa||t.DOMElementExtensions.setFocus(this.mc);return!oa}mh(Fa){if(null!=this.mc)return t.DOMElementExtensions.Af(this.mc,Fa);e.ULS.sendTraceTag(526197124,1,50,"FormulaSuggestionUIControl.belongsToSection: card rootElement should not be null.");return!1}sj(){}dk(){}show(Fa,oa,La,Ea,ca,$a=null,Qa=null,Va=null){if(!Qa&&this.$){Qa=this.grid.Sb(Va);if(!Qa){e.ULS.sendTraceTag(537161875,
1,50,"FormulaSuggestionUIControl.Show: failed to show UI, formattedActiveCell is null.");return}if(!Qa.cell.Pk){e.ULS.sendTraceTag(537161874,1,50,"FormulaSuggestionUIControl.Show: failed to show UI, formattedActiveCell is not in view.");return}Qa=this.grid.getCellBounds(Qa.cell,!0);e.ULS.shipAssertTag(537161873,1,!!Qa,"FormulaSuggestionUIControl.Show: target cell bounds should not be null.")}e.ULS.sendTraceTag(537161872,1,50,"FormulaSuggestionUIControl.Show: calling AppChrome API to render card UI.");
y.a(this.$).di(this);appChrome.renderFormulaSuggestionCard(Fa,oa,this.domElement,Qa.y,Qa.x,Qa.y+Qa.height,Qa.x+Qa.width,La,Ea,ca,$a,this.hyj)}hide(){e.ULS.sendTraceTag(537161871,1,50,"FormulaSuggestionUIControl.Hide: calling AppChrome API to unmount card UI.");y.a(this.$).Zz(this);appChrome.unmountReactComponent(this.domElement)}mea(Fa,oa,La){w.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.FBECurtainLifterCalloutForTestingOnlyEnabled",!1)&&(this.d2a&&Fa.equals(this.iwi)||(this.d2a&&document.body.removeChild(this.d2a),
this.iwi=Fa,Fa=this.grid.Sb(Fa),Fa=this.grid.getCellBounds(Fa.cell,!0),this.d2a=document.createElement("div"),this.d2a.setAttribute("style",`position:fixed;
        left: ${Fa.x+Fa.width}px;
        top: ${Fa.y+Fa.height/2}px`),document.body.appendChild(this.d2a)),Fa=new v.a(-847286761,0,this.$.Hc,0,null),this.$.Ja.Lb(Fa,{["CalloutName"]:15,["Target"]:this.d2a,["NewState"]:oa,["Reason"]:La}))}}Object(u.a)(C,"FormulaSuggestionUIControl",m.a,[228,34]);class B extends f.a{constructor(Fa){super(Fa)}ld(){e.ULS.sendTraceTag(528758224,0,50,"FormulaByExampleCommandHandlerFactory.CreateCommandHandlersAsync: FormulaByExampleCommandHandler init flow started.");const Fa=d.GetServiceTaskFactory.Oa(this.$.da,
453,454,1),oa=d.GetServiceTaskFactory.Oa(this.$.da,266,265,1);h.TaskExtensions.za(h.TaskExtensions.Ed([Fa,oa],this.ka),()=>{const La=this.$.da.Aa(328);this.Zc([new n.a(this.$,La,oa.result,Fa.result,C.instance())]);e.ULS.sendTraceTag(537161924,0,50,"FormulaByExampleCommandHandlerFactory.CreateCommandHandlersAsync: FormulaByExampleCommandHandler initialized successfully")},this.ka)}static la(Fa){f.a.Nd(455,new B(Fa))}}Object(u.a)(B,"FormulaByExampleCommandHandlerFactory",f.a,[]);var z=a(55);m=a(222);
var A=a(7),E=a(821),I=a(5),L=a(24),V=a(33),T=a(8);class H{constructor(Fa,oa,La){this.kind=Fa;this.value=oa;this.formatted=La}get displayText(){var Fa;return null!==(Fa=this.formatted)&&void 0!==Fa?Fa:this.value}}Object(u.a)(H,"CloneEvaluatedEdit",null,[]);class D{constructor(Fa,oa=null,La){this.status=Fa;this.lad=oa;this.Msc=La}}Object(u.a)(D,"FormulaByExampleFormulaEvalResult",null,[]);var G=a(22),J=a(851);class M{constructor(Fa,oa,La,Ea){this.Gif=this.WB=!1;this.$=Fa;this.calcManager=oa;this.WB=
Ea;this.sg=La;this.El=J.a.getInstance(this.$);this.gridView=x.h(this.$);this.Gif=w.EwaSettings.isChangeGateEnabled("OfficeVSO:6327953_FormatOutputResultsOfFBE_V2")}dwj(Fa,oa,La=null,Ea=!1,ca){oa=Fa.range.Ie(oa);return oa?this.EQe(Fa,oa,La).then($a=>{this.WB&&!Ea&&Fa.flowId&&Object(E.e)("CALCULATIONED",Fa.flowId,ca);if(2===$a.status)return $a;e.ULS.sendTraceTag(537161881,0,50,"FormulaByExampleModelUpdater:setFormulaPreviewOnRangeModel: evalFormulaRangeOnClone CSE: Result received from calc.");return this.LXj($a,
Ea,Fa.flowId,ca)}).catch($a=>{Object(E.g)(Fa,`failed to setFormulaPreviewOnRangeModel, error in calc API: ${$a.toString()}`,this.El,8);return Promise.reject(`FormulaByExampleModelUpdater:setFormulaPreviewOnRangeModel: Unable to EvalFormulaRange, e: ${$a.toString()}`)}):(Object(E.g)(Fa,"Annotation range does not intersect loaded range",this.El,6),Promise.reject("FormulaByExampleModelUpdater:setFormulaPreviewOnRangeModel: Annotation range does not intersect loaded range."))}EQe(Fa,oa,La=null){La=M.JIh(La);
this.El.sq(Fa.flowId,7);return this.calcManager.Tub(La,oa,Fa.originCell,Fa.formula).then(Ea=>{if(!this.ini(Ea))return Object(E.g)(Fa,"Result object from EvalOnClone API is empty or null.",this.El,8),new D(2);if(!this.tPg(Ea,Fa))return e.ULS.sendTraceTag(527005663,0,50,"FormulaByExampleModelUpdater:EvalFormulaRangeOnClone: Formula results from Calc.ts had errors."),new D(2);const ca=this.c1j(Ea,Fa);if(!ca.success)return Object(E.g)(Fa,`Evaluated results from calc do not match the user data in the grid or had errors from calc. reason: ${ca.reason}`,
this.El,8),e.ULS.sendTraceTag(537161880,0,50,"FormulaByExampleModelUpdater:EvalFormulaRangeOnClone:Formula results from Calc.ts do not match grid data."),new D(2);this.El.sq(Fa.flowId,11);e.ULS.sendTraceTag(537161879,0,50,"FormulaByExampleModelUpdater:EvalFormulaRangeOnClone: EvalFormulaRange CSE: Result received from calc.");return new D(0,Ea.results,ca.Msc)}).catch(Ea=>{Object(E.g)(Fa,`failed to EvalFormulaRangeOnClone, error in calc API: ${Ea.toString()}`,this.El,8);return Promise.reject(`FormulaByExampleModelUpdater:EvalFormulaOnRange: Unable to EvalFormulaRange, e: ${Ea.toString()}`)})}gRg(Fa,
oa){if(Fa)for(const Ea of Fa)if(excelOnlineCalc.util.isSuccess(Ea)){Fa=Ea;var La=c(Fa.value[0]);if(La=this.gridView.Sb(La))La=La.cell,La.text=this.qgd(Fa).displayText,La.formulaBarText=oa}}static JIh(Fa){const oa=La=>({row:La.cell.$Q,column:La.cell.ZQ,Gj:La.cell.Gj,text:La.cell.text});return Fa?Fa.map(oa):null}tPg(Fa,oa){if(w.EwaSettings.isChangeGateEnabled("OfficeVSO:6669310_FBEShowsSuggestionsWithCalcFailures"))return!0;for(const La of Fa.results){const {isSuccess:Ea,Z$c:ca,reason:$a}=this.aJh(La);
if(!Ea)return Object(E.g)(oa,`Calc failed to evaluate formula. reason json: ${$a} did result in error for formula output (#VALUE, #REF etc..): ${ca}`,this.El,8),!1}return!0}ini(Fa){return(Fa=Fa.results)&&Fa.length?!0:!1}aJh(Fa){if(excelOnlineCalc.util.isSuccess(Fa)){const oa=Fa.value[1];return 8===oa.kind?(Fa=c(Fa.value[0]),(Fa=this.gridView.Sb(Fa))&&Fa.cell.text&&e.ULS.shipAssertTag(537161878,0,!1,"FormulaByExampleModelUpdater:FormulaCalculationSucceeded: formula evaluation failed, bad formula provided"),
{isSuccess:!1,Z$c:!0,reason:JSON.stringify(oa.type)}):{isSuccess:!0,Z$c:!1,reason:null}}return{isSuccess:!1,Z$c:!1,reason:JSON.stringify(Fa.reason)}}LXj(Fa,oa,La,Ea){var ca=Fa.lad;for(const $a of ca)excelOnlineCalc.util.isSuccess($a)?(ca=$a.value[0])?(ca=c(ca),(ca=this.gridView.Sb(ca))?(ca.cell.OHd=this.qgd($a).displayText,Fa.status|=1):Fa.status|=2):Fa.status|=2:"Unavailable"!==$a.reason.kind&&(Fa.status|=2);this.WB&&!oa&&La&&Object(E.e)("MODELUPDATED",La,Ea);return Fa}c1j(Fa,oa){let La=null,Ea=
!1,ca=!1,$a=!1,Qa=!1,Va=!1,fb=!1;Fa=Fa.results;var Ka=Fa.entries();for(const hb of Ka){Ka=hb[0];const fc=this.d1j(hb[1],oa);fc.hCb&&(Ea=fc.g8b);fc.Wtd&&(ca=!0,$a||($a=fc.isInViewport),Va||(Va=fc.isInViewport&&!fc.cBb));Qa||(Qa=fc.cBb);fb||(fb=fc.Faf);La=null!==La&&void 0!==La?La:fc.I0a;(fc.Wtd||fc.cBb)&&Fa.splice(Ka,1)}Ea?this.El.sq(oa.flowId,10):this.El.sq(oa.flowId,9);return La?{success:!1,reason:La}:{success:!0,Msc:{["hasUnavailableCells"]:ca,["hasUnexpectedUnavailableCellsInViewport"]:Va,["hasHiddenRows"]:Qa,
["hasUnavailableCellsInViewport"]:$a,["hasErrorCells"]:fb}}}d1j(Fa,oa){var La;const Ea={hCb:!1,Wtd:!1,isInViewport:!1,cBb:!1,I0a:null,Faf:!1,g8b:!1};if(!excelOnlineCalc.util.isSuccess(Fa)){var ca=Fa.reason;Fa=L.Range.Qc(ca.cell.row+1,ca.cell.col+1);Ea.hCb=Fa.equals(oa.originCell);this.oXe(Ea,Fa);if(w.EwaSettings.isChangeGateEnabled("OfficeVSO:6669310_FBEShowsSuggestionsWithCalcFailures")){if("Unavailable"===ca.kind)return Ea.Wtd=!0,Ea;Ea.I0a=JSON.stringify({kind:ca.kind,innerKind:ca.innerKind})}Ea.I0a=
null!==(La=Ea.I0a)&&void 0!==La?La:"failure in calc";return Ea}ca=c(Fa.value[0]);Ea.hCb=ca.equals(oa.originCell);this.oXe(Ea,ca);La=this.gridView.Sb(ca);if(!La){if(Ea.isInViewport&&!Ea.cBb)return Ea.I0a="formatted grid cell is null",Ea;e.ULS.sendTraceTag(509682371,0,50,"FormulaByExampleModelUpdater:validateCalcResultMatchesCellData: did not fail suggestion when a formatted grid cell is null as this cell is hidden or not in view.");return Ea}var $a=this.qgd(Fa,this.Gif?La:null,oa.pjh);if(8===$a.kind)return Ea.Faf=
!0,Ea;Fa=La.text;if(!Fa)return Ea.g8b=!0,Ea;$a=$a.displayText;Ea.g8b=G.a.equals(Fa,$a,!1);Ea.g8b||(ca=oa.eif(ca)?Ea.hCb?"MODIFIEDEXAMPLE":"EXAMPLE":Ea.hCb?"MODIFIEDRESTOFRANGE":"RESTOFRANGE",Object(E.f)(Fa,$a.toString(),La.cell.Gj,"evalFormulaOnCloneToShowPreview",oa,ca),Ea.I0a="data strings do not match");return Ea}oXe(Fa,oa){Fa.isInViewport=this.gridView.MK(oa);Fa.cBb=this.gridView.Xd.cjc(oa)}AIh(Fa,oa,La){Fa=this.sg.qZe(Fa,oa.cell.Gj,0===oa.cell.YE?La:oa.cell.YE,oa.cell.UBa,oa.cell.wia);if(Fa.success)return Fa.fy;
e.ULS.sendTraceTag(509694294,0,50,"FormulaByExampleModelUpdater:formatCloneResult: formatCellsAction failed to format clone result according to cell format.");return null}qgd(Fa,oa,La){Fa=Fa.value[1];var Ea=1===Fa.kind?Fa._valueXL.toString():8===Fa.kind?T.a.bad[Fa.type-1]:Fa.value;oa&&!Fa.formattedText&&(Fa.formattedText=this.AIh(Ea,oa,La));return new H(Fa.kind,Ea,Fa.formattedText)}}Object(u.a)(M,"FormulaByExampleModelUpdater",null,[]);var Q;(function(Fa){Fa.accept="ACCEPT";Fa.decline="DECLINE";Fa.ignore=
"IGNORE"})(Q||(Q={}));Object(u.b)("PreviewOutcome",Q);var U;(U||(U={})).unseen="UNSEEN";Object(u.b)("EntryState",U);const Z=Object.assign(Object.assign({},U),Q);class P{constructor(Fa){this.state=Z.unseen;this.TLb=0;this.suggestion=Fa}Wci(){this.TLb+=1}}Object(u.a)(P,"SuggestionEntryInternal",null,[]);class S extends Map{bdc(Fa){return(Fa=this.getKey(Fa))?this.has(Fa)?this.get(Fa):null:null}B0c(Fa){const oa=this.getKey(Fa);if(!oa)return null;this.set(oa,new P(Fa));return this.get(oa)}Zjh(Fa){(Fa=
this.getKey(Fa.suggestion))&&this.delete(Fa)}NZj(Fa){const oa=this.bdc(Fa);oa&&(oa.suggestion=Fa);return oa}}Object(u.a)(S,"SuggestionsCache",Map,[]);class ja{constructor(Fa,oa){this.formula=Fa;this.TLb=this.state=0;this.zH=oa}}Object(u.a)(ja,"FormulaByExampleSuggestionsCacheEntry",null,[]);class X extends S{constructor(Fa,oa){super();this.calcManager=Fa;this.pK=oa}B0c(Fa){var oa=!1;const La=super.bdc(Fa);if(!La||(oa=La.suggestion.formula!==Fa.formula))return oa&&e.ULS.sendTraceTag(523842004,306,
20,`FormulaByExampleSuggestionsCache.cacheSuggestion: formula changed from last cache entry, overriding cache entry.
           Last example count: ${La.suggestion.zH}, current: ${Fa.zH}, oldFormula: ${La.suggestion.anonymizedFormula}, newFormula:${Fa.anonymizedFormula}`),e.ULS.sendTraceTag(537161877,306,20,`FormulaByExampleSuggestionsCache.cacheSuggestion: saving suggestion for table range. tableRange: ${Fa.table.usedRange}, columnNumber: ${Fa.column}, examplesCount ${Fa.zH}, hasPreviousSuggestion: ${this.has(this.getKey(Fa))}`),(oa=super.B0c(Fa))||e.ULS.sendTraceTag(528889932,306,15,"SuggestionsCache.cacheSuggestion: failed to cache table suggestion due to getTableColumnKey failure."),
this.pK.mea(Fa.originCell,3),oa;La.suggestion.zH!==Fa.zH&&(e.ULS.sendTraceTag(523842003,306,50,`FormulaByExampleSuggestionsCache.cacheSuggestion: formula didn't change from the last cache entry, but number of examples changed. Last example ${La.suggestion.zH}, current: ${Fa.zH}`),this.pK.mea(Fa.originCell,4),Fa.ada.zH=La.suggestion.ada.zH);return this.NZj(Fa)}bdc(Fa){const oa=super.bdc(Fa);return G.a.equals(null===oa||void 0===oa?void 0:oa.suggestion.formula,Fa.formula,!0)?oa:null}ujd(Fa,oa){Fa=this.u8e(Fa,
oa);return Fa?this.get(Fa):(e.ULS.sendTraceTag(528889931,306,15,"FormulaByExampleSuggestionsCache.getTableCachedSuggestion: failed to get cached table suggestion due to getTableColumnKey failure."),null)}getKey(Fa){return this.u8e(Fa.table,Fa.column)}u8e(Fa,oa){const La=this.calcManager.x5a(Fa);if(!La)return null;const Ea=Fa.usedRange,ca=oa-Ea.left;return 0>ca||ca>=La.count?(e.ULS.sendTraceTag(537161876,306,10,`FormulaByExampleSuggestionCache.getUniqueTableColumnIdentifier: invalid inputs. tableRange: ${Ea}, columnNumber: ${oa}, `+
`areAllTableHeadersAvailable: ${this.calcManager.kte(Fa,La)}`),null):(oa=La.na(ca))?Fa.name+"_"+oa:null}}Object(u.a)(X,"FormulaByExampleSuggestionsCache",S,[]);class Y{constructor(Fa){this.calcManager=Fa;this.cache=new Map}ujd(Fa,oa){Fa=this.T2h(Fa,oa);return Fa?this.cache.get(Fa):(e.ULS.sendTraceTag(523842E3,306,15,"FormulaByExampleSuggestionsCache.getTableCachedSuggestion: failed to get cached table suggestion due to getTableColumnKey failure."),null)}T2h(Fa,oa){return(oa=this.U2h(Fa,oa))?Fa.name+
"_"+oa:null}U2h(Fa,oa){const La=this.calcManager.x5a(Fa);if(!La)return null;Fa=Fa.usedRange;const Ea=oa-Fa.left;(0>Ea||Ea>=La.count)&&e.ULS.sendTraceTag(537161876,306,10,`FormulaByExampleSuggestionsCache.GetTableColumnName: invalid inputs: tableRange: ${Fa}, columnNumber: ${oa}.`);return La.na(Ea)}}Object(u.a)(Y,"FormulaByExampleSuggestionsCacheDeprecated",null,[]);var va=a(262);Q=a(724);var N=a(699);class ea extends Q.a{constructor(){super();this.rows=null;this.column=0;this.generatedFormula=this.formulas=
null;this.resultKind=this.invocationMethod=this.stateID=0;this.errorMessage=this.guid=null;this.H_=Object.assign(new N.a,{T_:ea.getTypeName(),B_:ea.Pd()})}static getTypeName(){return"AugLoop_FormulaByExample_FormulaByExampleAnnotation"}static Pd(){return["AugLoop_Core_Annotation"]}}Object(u.a)(ea,"FormulaByExampleAnnotation",Q.a,[]);var Ca=a(66),la=a(190),Ra=a(162);class lb extends ea{constructor(Fa,oa,La){super();Object.assign(this,oa);this.$=Fa;La&&(this.EWb=La.range,this.dVc=La.$ni,this.lug=La.valueType);
this.ada={flowId:this.flowId,zH:this.zH,originCell:this.originCell,anonymizedFormula:this.anonymizedFormula}}static F9e(Fa){return parseInt(Fa,10)}set flowId(Fa){this.SKc=Fa}get flowId(){void 0===this.SKc&&(this.SKc=lb.F9e(this.guid));return this.SKc}get formula(){var Fa;void 0===this.TWa&&(this.TWa=null===(Fa=this.generatedFormula)||void 0===Fa?void 0:Fa.formula)&&"="!==this.TWa.charAt(0)&&(e.ULS.sendTraceTag(524833933,306,50,"FormulaByExampleSuggestion.formula: appending = sign as formula prefix."),
this.TWa=`=${this.TWa}`);return this.TWa}set zH(Fa){this.hKc=Fa}get ybd(){return this.rows}get pjh(){return this.lug}get anonymizedFormula(){var Fa;void 0===this.D$d&&(this.D$d=null===(Fa=this.generatedFormula)||void 0===Fa?void 0:Fa.anonymizedFormula);return this.D$d}get zH(){void 0===this.hKc&&(this.hKc=this.ybd.length);return this.hKc}set originCell(Fa){this.EWb=Fa}get originCell(){void 0===this.EWb&&(e.ULS.sendTraceTag(524833932,306,10,`FormulaByExampleSuggestion.originCell: origin cell is not defined - falling back to first cell of annotation range. flowId: ${this.flowId}`),
this.EWb=L.Range.Qc(this.ybd[0],this.column));return this.EWb}get K2j(){void 0===this.dVc&&(this.dVc=null!==this.table);return this.dVc}get table(){void 0===this.Zmb&&(this.Zmb=Object(x.h)(this.$).Bb.Bj(this.originCell,!1));return this.Zmb}get range(){if(void 0===this.wx){const Fa=Object(Ra.a)(this.table);this.wx=new L.Range(Fa.top,this.column,Fa.bottom,this.column,!0,!0)}return this.wx}eif(Fa){return Fa.Cd(this.range)&&this.ybd.includes(Fa.top)}}Object(u.a)(lb,"FormulaByExampleSuggestion",ea,[]);
var Aa=a(121),da=a(868),aa=a(975),fa=a(974),Oa=a(425);class ba{constructor(Fa,oa,La,Ea,ca){this.jI=this.pK=this.MOb=this.mnc=null;this.PNa=this.WB=!1;this.KHd=null;this.nVd=!1;this.Pvb=null;this.M7f=!1;this.cNi=$a=>{e.ULS.sendTraceTag(520987789,306,50,`FormulaByExampleManager.onCloseCallback: closeReason = ${fa.a[$a]}`)};this.$Ih=($a,Qa)=>{e.ULS.sendTraceTag(528758222,306,50,"FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation received.");if($a=Qa.FM)if($a=new lb(this.$,$a,this.p3i(lb.F9e($a.guid))),
e.ULS.sendTraceTag(526984792,306,50,`FormulaByExampleManager.formulaByExampleAnnotationHandler: received annotation's flowId: ${$a.flowId}.`),this.El.sq($a.flowId,14),this.WB&&!this.PNa&&Object(E.e)("ANNOTATIONRECEIVED",$a.flowId),null!=$a.errorMessage)e.ULS.sendTraceTag(527005666,306,10,`FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation arrived with error message: ${$a.errorMessage}, flowId: ${$a.flowId}`),this.El.sq($a.flowId,15,{reason:"Annotation arrived with error message"});
else if($a.formula)e.ULS.sendTraceTag(509679808,306,20,`FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation with a formula suggestion arrived. flowId: ${$a.flowId}`),this.El.sq($a.flowId,16,{Nnc:$a.formula}),$a.K2j?(this.jI=$a,(Qa=this.MOb.B0c($a))?this.M7f&&1===$a.invocationMethod?e.ULS.sendTraceTag(523850754,306,50,"FormulaByExampleManager.formulaByExampleAnnotationHandler: session supports suggestions from cache only. returning early after caching suggestion."):$a.zH<da.a?e.ULS.sendTraceTag(528758220,
306,50,"FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation does not have enough examples to prompt a suggestion."):(e.ULS.sendTraceTag(527005665,306,50,`FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation with formula suggestion arrived. trying to suggest/apply it. flowID: ${$a.flowId}`),0===$a.invocationMethod?this.cwj($a):this.X7f(Qa)&&this.Ffg(Qa,!1,null)):e.ULS.sendTraceTag(509678998,306,15,`FormulaByExampleManager.formulaByExampleAnnotationHandler: failed to cache suggestion for flowId: ${$a.flowId}.`)):
e.ULS.sendTraceTag(509690137,306,10,"FormulaByExampleManager.formulaByExampleAnnotationHandler: session supports suggestions on tables  only.");else{e.ULS.sendTraceTag(528758221,306,50,`FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation does not have any formula suggestions. flowId: ${$a.flowId}`);if(Qa=this.MOb.ujd($a.table,$a.column))this.MOb.Zjh(Qa),e.ULS.sendTraceTag(512258437,306,50,`FormulaByExampleManager.formulaByExampleAnnotationHandler: existing suggestion cache entry deleted. flowId: ${$a.flowId}`);
this.pK.mea($a.originCell,2);this.El.sq($a.flowId,15)}else e.ULS.sendTraceTag(537161922,306,15,"FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation is null.")};this.Zrj=()=>{e.ULS.sendTraceTag(537161889,306,50,"FormulaByExampleManager.SendByExampleFeedback: opening send feedback dialog after click on card.");const $a={};$a[I.a.DQ]="FormulaByExampleCard";this.$.Xc(802602464,0,8,$a)};this.uXi=$a=>{this.nVd=!0;e.ULS.sendTraceTag(537161888,306,50,`FormulaByExampleManager.OnShowFormula: user clicked ShowFormula button in the card for flow ${$a}`)};
this.l8h=$a=>{e.ULS.sendTraceTag(528758219,306,50,"FormulaByExampleManager.HandleNewBlocksDuringPreview: new block arrived during preview mode.");var Qa=$a.Yc.block,Va=Object(Ra.a)(this.jI.table);const fb=this.jI.range.Ie(Qa.pf);Va=(new L.Range(Va.top,Va.left,Va.bottom,Va.right,!0,!0)).Ie(Qa.pf);Qa=Array.from(this.gridView.Tja(Va,Qa));e.ULS.sendTraceTag(537161886,306,50,`FormulaByExampleManager.HandleNewBlocksDuringPreview: putting skeleton for preview cells in new block ${$a.Yc.hash}.`);this.A1d(fb,
!0);this.FQe(this.jI,Va,Qa).then(Ka=>{e.ULS.sendTraceTag(537161885,306,50,`FormulaByExampleManager.HandleNewBlocksDuringPreview: putting calculated data into model and demanding re-render for block ${$a.Yc.hash}.`);this.A1d(fb,!1);this.PR.puf($a.Yc.block);e.ULS.sendTraceTag(512508567,306,50,`FormulaByExampleManager.handleNewBlocksDuringPreview: new FormulaByExample suggestion block rendered during preview. results: ${JSON.stringify({["flowId"]:this.jI.flowId,["originalFlowId"]:this.jI.ada.flowId,
["formulaAnonymized"]:this.jI.anonymizedFormula,["originalFormulaAnonymized"]:this.jI.ada.anonymizedFormula,["annotationRange"]:this.jI.range.toString(),["previewCellsMetadata"]:Ka.Msc})}`);return!0}).catch(Ka=>{Object(E.g)(this.jI,`Exception when rendering new block during preview. ${Ka}`);e.ULS.sendTraceTag(537161884,306,50,`FormulaByExampleManager.HandleNewBlocksDuringPreview: caught exception: ${Ka}.`)})};this.zUf=()=>{this.$.userOperationManager.ko(this.qEd);this.qEd=null};this.iqc=($a,Qa)=>
{0==Qa.Lr&&(this.PNa&&this.KHd.Twa(`UserOperation: ${Aa.a(Qa.Tf.operation.operationName)}`),this.$.userOperationManager.ko(this.iqc))};this.wSi=($a,Qa)=>{e.ULS.sendTraceTag(528023709,306,20,`FormulaByExampleManager.onImmediateUndo: undo operation queued following a formula by example suggestion application. flowId=${$a} originalFlowId=${Qa}`)};this.$=Fa;this.M7f=w.EwaSettings.isChangeGateEnabled("OfficeVSO:6169955_ShowCachedFormulaByExampleSuggestionsOnly");this.augmentationLoopManager=oa;this.calcManager=
La;this.sg=Ea;this.Pvb=new Map;this.gridView=Object(x.h)(this.$);this.pK=ca;this.El=J.a.getInstance(this.$);this.PR=this.gridView.PR;this.NHd=!1;V.a.kic(this.$)?this.init():e.ULS.sendTraceTag(537161923,306,10,"FormulaByExampleManager.Ctor: not expected to be constructed when FG is off.")}jZi(Fa,oa,La,Ea){var ca;const $a=null===(ca=this.gridView.Sb(Fa))||void 0===ca?void 0:ca.cell.YE;this.Pvb.set(oa,{range:Fa,$ni:La,valueType:$a});La?(this.NHd=!1,La=this.gridView.Bb.Bj(Fa,!1),(La=this.MOb.ujd(La,Fa.left))?
(this.El.sq(oa,4),ca=this.X7f(La),ca.value?(La.suggestion.flowId=oa,La.suggestion.originCell=Fa,e.ULS.sendTraceTag(529109774,306,50,"FormulaByExampleManager.onTableInput: A cached formula suggestion found for current input."),this.Ffg(La,!0,Ea)):(this.El.sq(oa,6,{reason:ca.reason}),this.H1j(oa,La.suggestion,Fa))):this.El.sq(oa,5)):e.ULS.shipAssertTag(524940241,306,!1,"FormulaByExampleManager.onUserInput: expected to be called on tables only.")}H1j(Fa,oa,La){w.EwaSettings.isChangeGateEnabled("OfficeVSO:7041480_FormulaByExampleFlowAggregatorFixed")&&
this.calcManager.evalFormula(oa.formula,La,Ca.d(this.$.oa),excelOnlineCalc.calc.evalFormulaFormatOrigin()).then(Ea=>{var ca=this.gridView.Sb(La);const $a=ca.text;ca=ca.cell.Gj;Ea=Ea.value.value.toString();G.a.equals($a,Ea,!1)?this.El.sq(Fa,10):(Object(E.f)($a,Ea,ca,"evalFormulaToVeriySuggestionWithoutShowingPreview",oa,oa.eif(La)?"MODIFIEDEXAMPLE":"MODIFIEDRESTOFRANGE"),this.El.sq(Fa,9))}).catch(Ea=>{Ea=`Failed to evalFormula, error in calc API: ${Ea.toString()}`;e.ULS.sendTraceTag(512341207,306,
50,`FormulaByExampleMangaer.verifySuggestionOnEditedCell: ${Ea}`);this.El.sq(Fa,9,{reason:Ea})})}dispose(){this.$.userOperationManager.ko(this.iqc);this.zUf();this.augmentationLoopManager.unregister("FormulaByExample")}init(){const {FormulaByExampleAutoSuggestActor:Fa}=a(1320);this.augmentationLoopManager.register(this.augmentationLoopManager.Lbc().iyc("FormulaByExample").Wxc(this.cNi).activateAnnotation({annotationType:ea.getTypeName(),w_:!1,mPa:this.$Ih}).build());this.WB=Object(E.a)(this.$);new Fa(this.$,
this.calcManager,this.WB);this.MOb=new X(this.calcManager,this.pK);this.mnc=new M(this.$,this.calcManager,this.sg,this.WB);e.ULS.sendTraceTag(528758223,306,50,"FormulaByExampleManager.init: init complete.")}p3i(Fa){if(!this.Pvb.has(Fa))return null;const oa=this.Pvb.get(Fa);this.Pvb.delete(Fa);return oa}cwj(Fa){this.mnc.EQe(Fa,Fa.range,null).then(oa=>{this.OYc(Fa,1===oa.status?oa.lad:null);return null}).catch(()=>{e.ULS.sendTraceTag(537161921,306,50,"FormulaByExampleManager.setFormulaOnRangeExplicit: client estimation failed for explicit by example flow.");
this.OYc(Fa,null)})}Ffg(Fa,oa,La){e.ULS.sendTraceTag(527713160,306,20,`FormulaByExampleManager.tryDisplayFormulaSuggestionPreview: starting flow to show a formula suggestion. isFromCache: ${oa}`);const Ea=Fa.suggestion;this.WB&&!this.PNa&&Object(E.e)("CALCULATIONSTART",Ea.flowId,oa);var ca=w.EwaSettings.isChangeGateEnabled("OfficeVSO:7189977_SendCloneUpdatesOnPreview")?this.a3e(Object(Ra.a)(Ea.table)):null;ca=this.FQe(Ea,this.gridView.ui,ca,oa);const $a=ca.then(()=>this.PR.Peb(Ea.range,this.l8h).then(Qa=>
{this.PNa=!0;this.KHd=Qa;this.$.userOperationManager.ur(this.iqc);this.WB&&la.a(()=>{Object(E.e)("PREVIEWRENDERED",Ea.flowId,oa);const Va=Object(E.d)(oa,Ea.flowId);e.ULS.sendTraceTag(529109772,306,50,`FormulaByExampleManager.TryDisplayFormulaSuggestionPreview: durations for preview shown flow: ${JSON.stringify(Va)}`)},this.$.ka);this.pK.show(Ea.formula,Ea.range.toString(),()=>Qa.HZb("CardUI"),()=>Qa.w7b("CardUI"),this.Zrj,()=>this.uXi(Ea.flowId),void 0,Ea.originCell);this.pK.mea(Ea.originCell,0);
return Qa.enj}));Promise.all([ca,$a]).then(Qa=>{this.NHd=!0;this.A8h(Qa[0],Qa[1],Fa,oa,La)}).catch(Qa=>{Object(E.g)(Ea,`Failed to show formula preview due to a promise (model update or preview render) rejection. rejection reason: ${Qa}`);e.ULS.sendTraceTag(537161920,306,15,`FormulaByExampleManager.TryDisplayFormulaSuggestionPreview: failed to show formula preview due to promise rejection. rejection reason: ${Qa}`);this.pK.mea(Ea.originCell,5,Qa);Fa.state=Z.ignore})}FQe(Fa,oa,La=null,Ea){return this.mnc.dwj(Fa,
oa,La,this.PNa,Ea).then(ca=>{e.ULS.sendTraceTag(537161887,306,50,`FormulaByExampleManager.EvaluateFormulaAndUpdateModel: model update completed. result: ${ca.status}.`);switch(ca.status){case 3:case 1:return 3===ca.status&&Object(E.g)(Fa,"Preview shown, but only partially. some cells failed to evaluate."),Promise.resolve(ca);case 2:return Promise.reject("Calc estimation or model update failed");default:return Promise.reject("Calc estimation failed")}})}A8h(Fa,oa,La,Ea,ca){const $a=this.nVd;this.Llj();
const Qa=La.suggestion;this.WB&&Object(E.e)("USERINPUTARRIVED",Qa.flowId,Ea);this.A1d(Qa.range,!1);this.pK.hide();la.a(()=>{this.WB&&Object(E.e)("PREVIEWREMOVEDWITHCSE",Qa.flowId,Ea);const Va={["flowId"]:Qa.flowId,["originalFlowId"]:Qa.ada.flowId,["caller"]:oa.eAe,["triggerConmmand"]:Object(Oa.a)(ca),["formulaAnonymized"]:Qa.anonymizedFormula,["originalFormulaAnonymized"]:Qa.ada.anonymizedFormula,["suggestionOutcome"]:oa.Nsc,["annotationRange"]:Qa.range.toString(),["isFullyInViewport"]:this.gridView.MK(Qa.range),
["isCachedSuggestion"]:Ea,["showFormulaClicked"]:$a,["exampleCount"]:Qa.zH,["originalExampleCount"]:Qa.ada.zH,["seenCount"]:La.TLb,["previewCellsMetadata"]:Fa.Msc,["previewShownDurations"]:this.WB?Object(E.d)(Ea,Qa.flowId):"none",["previewRemovedDurations"]:this.WB?Object(E.c)(Ea,Qa.flowId):"none"};e.ULS.sendTraceTag(388780100,306,50,`FormulaByExampleManager.handlePreviewResult: FormulaByExample flow results: ${JSON.stringify(Va)}`);Object(E.b)(Qa.flowId)},this.$.ka);e.ULS.sendTraceTag(523842074,
306,50,`FormulaByExampleManager.handlePreviewResult: User ${oa.Nsc} the formula via ${oa.eAe}`);La.state=oa.Nsc;La.Wci();"ACCEPT"===oa.Nsc&&this.OYc(Qa,Fa.lad);this.$.userOperationManager.ko(this.iqc)}Llj(){this.PNa=!1;this.KHd=null;this.nVd=!1}OYc(Fa,oa){const La=Object(A.a)(new va.a,{Text:Fa.formula});this.gridView.setCell(La,Fa.originCell,1,127,null,0,Fa.range,2);this.mnc.gRg(oa,Fa.formula);e.ULS.sendTraceTag(537161883,306,50,`FormulaByExampleManager.applyFormulaSuggestionOnRange: applied formula on table, range: ${Fa.range}`);
this.qEd=(Ea,ca)=>{0==ca.Lr&&(170==ca.Tf.operation.operationName&&this.wSi(Fa.flowId,Fa.ada.flowId),this.zUf())};this.$.userOperationManager.ur(this.qEd)}X7f(Fa){const oa=Fa.suggestion;return this.Pki(Fa.suggestion.flowId)?Fa.state===Z.decline?(this.pK.mea(Fa.suggestion.originCell,6,aa.a.Hpg),e.ULS.sendTraceTag(528758217,306,50,`FormulaByExampleManager.shouldShowPreview: user declined this suggestion before, not showing again. flowId: ${oa.flowId}`),{value:!1,reason:"User declined this suggestion before."}):
oa.zH<da.a?(this.pK.mea(Fa.suggestion.originCell,6,aa.a.epg),e.ULS.sendTraceTag(528758215,306,50,`FormulaByExampleManager.shouldShowPreview: cached suggestion does not have enough examples. not showing preview. flowId: ${oa.flowId}`),{value:!1,reason:"Cached suggestion does not have enough examples."}):!w.EwaSettings.isChangeGateEnabled("OfficeVSO:7161866_FBE_ShowIgnoredSuggestionsIndefinitely")&&Fa.state===Z.ignore&&2<=Fa.TLb?(this.pK.mea(Fa.suggestion.originCell,6,aa.a.Gpg),e.ULS.sendTraceTag(528758216,
306,50,`FormulaByExampleManager.shouldShowPreview: user saw suggestion at least twice and ignored last time. not showing again. flowId: ${oa.flowId}`),{value:!1,reason:"User saw suggestion at least twice and ignored last time"}):w.EwaSettings.isChangeGateEnabled("OfficeVSO:7300192_FBETextCellsUnsupported")&&this.a3e(oa.range).some(La=>this.calcManager.kti(La.cell.Gj))?{value:!1,reason:"At least 1 cell in the loaded suggestion range is formatted as Text"}:{value:!0}:(this.pK.mea(Fa.suggestion.originCell,
6,aa.a.Yng),{value:!1,reason:"Client state is not available for preview."})}A1d(Fa,oa){for(let Ea=Fa.top;Ea<=Fa.bottom;Ea++)for(let ca=Fa.left;ca<=Fa.right;ca++){var La=L.Range.Qc(Ea,ca);if(La=this.gridView.Sb(La))La.cell.E9f=oa&&!La.cell.OHd}}Pki(Fa){return this.NHd?(e.ULS.sendTraceTag(528758218,306,50,`FormulaByExampleManager.shouldShowPreview: can't show preview again as preview already was shown for the current edit. flowId: ${Fa}`),!1):this.PNa?(e.ULS.sendTraceTag(527005664,306,50,`FormulaByExampleManager.shouldShowPreview: can't show preview for this suggestion as preview is already showing. flowId: ${Fa}`),
!1):this.gridView.eb?(e.ULS.sendTraceTag(524813027,306,50,`FormulaByExampleManager.shouldShowPreview: can't show preview for this suggestion as user is editing. flowId: ${Fa}`),!1):!0}a3e(Fa){let oa=[];const La=this.gridView.Da.Uva(Fa,this.gridView.$.activeItemName);for(const Ea of La)oa.push(...this.gridView.Tja(Fa.Ie(Ea.pf),Ea));return oa}}Object(u.a)(ba,"FormulaByExampleManager",null,[242,2]);class ka extends m.a{constructor(Fa){super();this.$=Fa;this.Fb()}create(){e.ULS.sendTraceTag(528758214,
0,50,"FormulaByExampleManagerFactory.Create: starting service creation flow.");const Fa=d.GetServiceTaskFactory.Oa(this.$.da,328,327,1),oa=d.GetServiceTaskFactory.Oa(this.$.da,266,265,1),La=w.EwaSettings.isChangeGateEnabled("OfficeVSO:6327953_FormatOutputResultsOfFBE_V2")?d.GetServiceTaskFactory.create(this.$.da,18,this.$.ka,1):z.Task.Ta(null),Ea=[Fa,oa,La];C.init(this.$);h.TaskExtensions.za(h.TaskExtensions.Ed(Ea,this.ka),()=>{e.ULS.sendTraceTag(528758213,0,50,"FormulaByExampleManagerFactory.Create: augmentationLoopManager and calcManager creation tasks resolved.");
const ca=new ba(this.$,Fa.result,oa.result,La.result,C.instance());this.nb(this.$.da.Aa(453)||this.$.da.Ga(453,ca));e.ULS.sendTraceTag(537161882,0,50,"FormulaByExampleManagerFactory.Create: FormulaByExampleManager initialized successfully")},this.ka)}static la(Fa){Fa.da.Ga(454,new ka(Fa))}}Object(u.a)(ka,"FormulaByExampleManagerFactory",m.a,[]);a.d(F,"a",function(){return Pa});const Pa=()=>{b.a.Fa(Fa=>{ka.la(Fa);B.la(Fa)})}},1284:function(u,F,a){u=a(0);var c=a(7),b=a(15),e=a(24),f=a(33),d=a(162),
h=a(184),n=a(21),m=a(869),x=a(699);class r extends m.a{constructor(){super();this.formulasCount=this.columnNames=this.additionalInputs=this.examples=null;this.invocationMethod=this.stateID=0;this.guid=this.supportedFunctions=null;this.H_=Object.assign(new x.a,{T_:r.getTypeName(),B_:r.Pd()})}static getTypeName(){return"AugLoop_FormulaByExample_FormulaByExampleSignal"}static Pd(){return["AugLoop_Signals_Signal"]}}Object(u.a)(r,"FormulaByExampleSignal",m.a,[]);var y=a(1292),t=a(55),v=a(821),w=a(1),C=
a(290),B=a(851),z=a(40),A=a(100),E=a(868);a.d(F,"b",function(){return L});a.d(F,"a",function(){return V});const I={TEXTSPLIT:!1,TEXTSLICE:!1,FINDN:!1,TEXTAFTER:!1,TEXTBEFORE:!1},L={R9c:"editRange",dgb:"triggerCommand",y_d:"triggerKind",IYe:"flowId",jjf:"isInTable"};class V{constructor(T,H,D,G,J){this.WB=!1;this.$=T;this.gridView=Object(n.h)(T);this.augmentationLoopManager=H;this.calcManager=D;this.formulaByExampleManager=G;this.pK=J;this.El=B.a.getInstance(this.$);this.WB=Object(v.a)(this.$);this.sFi=
w.EwaSettings.getIntFeatureGate("Microsoft.Office.Excel.FormulaByExampleMaximalNumberOfAdditionalInputRows",30);b.ULS.sendTraceTag(528758226,306,50,"FormulaByExampleCommandHandler.ctor: FBE command handler created")}nc(){return!1}executeCommand(T,H,D){T=!1;H=H.command;switch(H){case 1928326585:T=D&&D[L.y_d]?D[L.y_d]:0;const G=D[L.IYe];if(0===T)return b.ULS.sendTraceTag(524940245,306,15,"FormulaByExampleManager.executeCommand: triggerFormulaByExample command called for execution with NoTrigger value."),
this.El.sq(G,1),t.Task.Ta(!0);const J=!D||!D[L.R9c],M=this.ISh(D,J),Q=!D||D[L.jjf];D=!D||D[L.dgb];J||2!==T||this.formulaByExampleManager.jZi(M,G,Q,D);T=this.triggerFormulaByExample(M,J,G,Q)}return T?t.Task.Ta(!0):Object(h.a)(H)}wc(T,H){switch(H.command){case 1928326585:return f.a.kic(this.$);default:return!1}}Kc(){return!1}ISh(T,H){b.ULS.sendTraceTag(537161928,306,50,`FormulaByExampleCommandHandler.getEditedRange: flow triggered from: ${H?"Ribbon":"AutoDetect"}`);return H?this.gridView.ha.ra.activeCell:
T[L.R9c]}triggerFormulaByExample(T,H,D,G){if(!this.augmentationLoopManager)return b.ULS.sendTraceTag(537161927,306,10,"FormulaByExampleCommandHandler.TriggerFormulaByExample: augmentationLoopManager instance is null"),this.El.sq(D,13,{reason:"AugmentationLoopManager instance is null"}),!1;let J;if(G){G=this.gridView.Bb.Bj(T,!1);if(!G)return b.ULS.sendTraceTag(537161925,306,15,"FormulaByExampleCommandHandler.TriggerFormulaByExample: table returned null for given edit range."),this.El.sq(D,13,{reason:"Table returned null for given edit range"}),
!1;J=this.pUh(T,H,G,D)}if(!J)return this.El.sq(D,13,{reason:"Signal is null"}),!0;b.ULS.sendTraceTag(537161926,306,50,`FormulaByExampleCommandHandler.TriggerFormulaByExample: calling SubmitOperationSignal for flowId: ${D}.`);this.augmentationLoopManager.MXd(J);this.El.sq(D,12);this.pK.mea(T,1);this.WB&&Object(v.e)("SIGNALSENT",D);return!0}pUh(T,H,D,G){T=this.MOh(D,T,G);if(!T)return null;D=this.cQh(D);if(!D)return null;H=Object(c.a)(new r,{formulasCount:1,examples:T.examples,additionalInputs:T.additionalInputs,
columnNames:D,stateID:this.$.ea.jDb,invocationMethod:H?0:1,guid:G.toString(),supportedFunctions:I});b.ULS.sendTraceTag(528758225,306,50,"FormulaByExampleCommandHandler.getFormulaByExampleSignalFromTable: signal generated.");return H}MOh(T,H,D){T=Object(d.a)(T);return this.NOh(T,H,D)}cQh(T){const H=[],D=T.name;var G=Object(d.a)(T);T=this.calcManager.x5a(T);if(G&&T){G=G.left;for(let J of T)H.push({column:G,name:D+"[@["+J+"]]"}),G++;return H}b.ULS.sendTraceTag(524940244,306,15,`FormulaByExampleCommandHandler.getColumnNamesMapFromTable: failed to generate columnNames. is tableRange null: ${!G}, is colNamesCurrentTable null: ${!T}`);
return null}NOh(T,H,D){H=H.left;let G=new Set;w.EwaSettings.isChangeGateEnabled("OfficeVSO:7126337_FBECellCycleFix")&&(G=this.iUh(T,H,D));return this.Agh(T,H,G)}iUh(T,H,D){const G=new Set,J=this.gridView.jk("FormulaByExample.getForbiddenColumnsFromRange",T);try{for(;J.$$mn();){const M=J.$$cu(),Q=M.range,U=Q.left;if(U!==H&&!G.has(U)){const Z=new e.Range(Q.top,H,Q.top,H,!1,!1);this.Kli(M,Z)&&(G.add(U),this.El.Moc(D,U-(this.$.oa.displayRtl?T.right:T.left)))}}}finally{J&&J.dispose()}return G}Agh(T,H,
D){const G=[],J=[],M=T.right,Q=new Set;let U=[],Z=!1,P=null;T=this.gridView.jk("FormulaByExample.createValidExamplesFromRange",T);try{for(;T.$$mn();){const S=T.$$cu(),ja=S.range.left,X=ja===H;X&&S.text?P=this.mHe(S):X||D.has(ja)||(S.text&&(Z=!0),U.push(this.mHe(S)));ja===M&&(Z&&(P?(G.push({output:P,inputs:U}),Q.add(P.rawValueJson)):J.length<this.sFi&&J.push({output:null,inputs:U})),U=[],Z=!1,P=null)}}finally{T&&T.dispose()}return Q.size<E.a?(b.ULS.sendTraceTag(509683013,306,50,"FormulaByExampleCommandHandler.createValidExamplesFromRange: column does not have enough distinct examples with inputs."),
null):{examples:G,additionalInputs:J}}Kli(T,H){const D=T.HS,G=T.range,J=this.$.workbookContext.WorkbookFileName,M=this.$.oa;if(!M)return b.ULS.sendTraceTag(509743199,306,50,"FormulaByExampleCommandHandler.isDependingOn: this.ewaControl.activeItem returned null. Expected to be an object of type Sheet."),!1;if(!(w.EwaSettings.isChangeGateEnabled("OfficeVSO:7251463_FBEFixJsCrashOnNullActiveSheet")||M instanceof A.a))return b.ULS.sendTraceTag(509743198,306,50,"FormulaByExampleCommandHandler.isDependingOn: this.ewaControl.activeItem returned object of type other then Sheet. Expected to be an object of type Sheet."),
!1;if(!this.calcManager.Iif(T.cell.Gj,D))return!1;if(T=this.calcManager.extractReferences(D,M.name,J,!0,G))for(const Q of T.Items)if(Object(z.D)(Q.Range).equals(H))return!0;return!1}mHe(T){let H;if(1===T.qx.type){H=parseFloat(T.qx.value);var D=this.calcManager.f5a(T.cell.Gj);Object(C.c)(D)?D=D.value.isDate?4:D.value.isTime?5:1:(b.ULS.sendTraceTag(522840207,0,10,`FormulaByExampleCommandHandler.createAugLoopCell: CalcManager's getNumberFormat method failed on the given cell, falling back to number format. failureReason: ${D.reason}`),
D=1)}else H=T.text,D=0;return Object.assign(new y.a,{row:T.range.top,column:T.range.left,displayText:T.text,rawValueJson:JSON.stringify(H),numberFormatCategory:D.toString()})}}Object(u.a)(V,"FormulaByExampleCommandHandler",null,[208])},1320:function(u,F,a){a.r(F);a.d(F,"FormulaByExampleAutoSuggestActor",function(){return y});u=a(0);var c=a(15),b=a(24),e=a(162),f=a(92),d=a(21),h=a(821),n=a(1284),m=a(868),x=a(851),r=a(1);class y{constructor(t,v,w){this.WB=!1;this.FPa=(C,B)=>{B.Vrb&&this.gridView.Bb.y_(B.lk)?
(this.eef(B.lk,324156914),this.Dki(B.lk)?this.HCf(B.lk,B.lk,324156914):this.HRa()):this.HRa()};this.iEd=(C,B)=>{C=B.destinationRange;if(1804571062===B.command||C.left!==C.right)this.HRa();else{var z=new b.Range(C.top,C.right,C.top,C.right,!1,!1);this.gridView.Bb.y_(z)?(this.eef(z,B.command),this.HCf(z,C,B.command)):this.HRa()}};this.$Xi=(C,B)=>{C=this.rlc.q1g;B=B.lk.toString();C.has(B)&&(C.delete(B),0===C.size&&this.JMe())};this.$=t;this.gridView=d.h(t);this.calcManager=v;this.WB=w;this.HRa();this.gridView.Vb.Rm(this.FPa);
this.calcManager.lLg(this.$Xi);r.EwaSettings.isChangeGateEnabled("OfficeVSO:7395435_FormulaByExampleTriggerOnCSEPaste")&&this.gridView.Xre(this.iEd);this.El=x.a.getInstance(t)}HCf(t,v,w){this.x4f(t,v,w);-185374993===w&&this.JMe()}eef(t,v){const w=this.gridView.Bb.Bj(t,!1);this.El.PBf(v,w.name,t.left-(w.displayRtl?w.usedRange.right:w.usedRange.left),t.top-w.usedRange.top)}Dki(t){var v=this.gridView.Sb(t);if(!v)return c.ULS.sendTraceTag(524120778,306,15,`FormulaByExampleAutoSuggestActor.isCellValidForTriggeringFormulaByExample: formattedCell is null. investigation hints: is cell null = ${!t}`),
this.El.sq(x.b,1,{reason:"Didn't trigger since the formattedCell is null."}),!1;t=this.calcManager.Iif(v.cell.Gj,v.HS);(v=null!==t&&!t)||this.El.sq(x.b,1,{reason:`Didn't trigger since edited cell content is a formula or isFormulaCell returned null. isFormulaText is null:${null==t}`});return v}JMe(){const t=this.V3h(this.rlc.originCell);if(0===t)this.HRa(),this.El.sq(x.b,1);else{var v=this.El.U4e();this.El.sq(v,3);c.ULS.sendTraceTag(537161929,306,50,`FormulaByExampleAutoSuggestActor.tryTriggeringFormulaByExample: triggering FormulaByExample for cell edit. Trigger kind: ${t}, FlowId: ${v}`);
this.WB&&Object(h.e)("EDITCOMMIT",v);var w=new f.a(1928326585,1,2,6,null);this.$.Ja.Lb(w,{[n.b.R9c]:this.rlc.originCell,[n.b.dgb]:this.rlc.dgb,[n.b.y_d]:t,[n.b.IYe]:v,[n.b.jjf]:!0});this.HRa()}}V3h(t){return this.gridView.Bb.Zkf(t)?(this.El.sq(x.b,1,{reason:"Didn't trigger since edited cell is a table header"}),0):this.Qqj(t)}Qqj(t){var v=this.gridView.Bb.Bj(t,!1);v=e.a(v);t=t.left;t=new b.Range(v.top,t,v.bottom,t,!0,!0);return this.Pqj(t)}Pqj(t){var v;let w=new Set,C=0;t=this.gridView.jk("FormulaByExampleAutoSuggestActor:Table",
t);try{for(;t.$$mn();){const B=t.$$cu();if(null===(v=B.qx)||void 0===v?0:v.value)if(w.add(B.qx.value),C++,w.size>=m.a)return 2}}finally{t&&t.dispose()}C>=m.a?(c.ULS.sendTraceTag(523368219,306,50,"FormulaByExampleAutoSuggestActor.searchForSufficientExamplesInOutputColumn: Table has sufficient example amount - but not enough distinct examples."),this.El.sq(x.b,1,{reason:"Didn't trigger since there aren't enough distinct outputs"})):this.El.sq(x.b,1,{reason:"Didn't trigger since there aren't enough examples"});
return 0}HRa(){this.x4f(null,null,null)}x4f(t,v,w){this.rlc={originCell:t,q1g:new Set(null===v||void 0===v?void 0:v.jwe(v.RC).map(C=>C.toString())),dgb:w}}}Object(u.a)(y,"FormulaByExampleAutoSuggestActor",null,[])},1438:function(u,F,a){function c(ta){return void 0===ta?"undefined":`${null===ta||void 0===ta?void 0:ta.Xluid}/${null===ta||void 0===ta?void 0:ta.Xrevid}@${null===ta||void 0===ta?void 0:ta.DocId}`}a.r(F);u=a(0);var b=a(7),e=a(15),f=a(98);F=a(222);class d{}Object(u.a)(d,"WorkbookCoauthVersion",
null,[]);var h=a(38);class n{constructor(){this.stateId=0;this.c2d=null}}Object(u.a)(n,"StateIdChangedInfo",null,[]);var m=a(60);const x=(ta,wa,db,Jb,Pb,eb,Ma=null)=>{Ma=ta.Na(1,Ma);Ma.isObserverRequired=wa;return m.g(ta,"ObserverRequiredNotification",Ma,db,Jb,Pb,eb,0)};class r extends Sys.EventArgs{constructor(ta,wa,db,Jb){super();this.FM=ta;this.parentPath=db;this.operationType=Jb}}Object(u.a)(r,"AnnotationReceivedEventArgs",Sys.EventArgs,[]);var y=a(28),t=a(118),v=a(1);class w{constructor(){this.stateUpdateHandler=
this.handler=this.config=this.annotationType=null}}Object(u.a)(w,"ActivateAnnotationParameters",null,[]);class C{constructor(){this.supportCustomMessages=this.accessTokenTTL=this.accessToken=this.collabStateId=this.userListVersion=this.configurations=this.permissionFlags=this.serverEventVersion=this.metadataVersion=this.ecsOperationUrl=this.ecsRestUrl=this.ecsSessionId=this.wacCluster=null}}Object(u.a)(C,"ExcelServerParameters",null,[]);class B{constructor(){this.excelServerParameters=null}}Object(u.a)(B,
"ForceReconnectParameters",null,[]);class z{constructor(){this.workflow=null}}Object(u.a)(z,"RegisterLocalWorkflowParameters",null,[]);class A{constructor(){this.handler=null}}Object(u.a)(A,"SetAnnotationResultCallbackParameters",null,[]);class E{constructor(){this.message=null}}Object(u.a)(E,"SubmitCustomMessageParameters",null,[]);class I{constructor(){this.operation=null}}Object(u.a)(I,"SubmitOperationParameters",null,[]);var L=a(724),V=a(971),T=a(753),H=a(699);class D extends T.a{constructor(){super();
this.H_=Object.assign(new H.a,{T_:D.getTypeName(),B_:D.Pd()})}static getTypeName(){return"AugLoop_Core_DeleteOperation"}static Pd(){return["AugLoop_Core_Operation"]}}Object(u.a)(D,"DeleteOperation",T.a,[]);class G extends T.a{constructor(){super();this.isFocused=!1;this.H_=Object.assign(new H.a,{T_:G.getTypeName(),B_:G.Pd()})}static getTypeName(){return"AugLoop_Core_FocusOperation"}static Pd(){return["AugLoop_Core_Operation"]}}Object(u.a)(G,"FocusOperation",T.a,[]);var J=a(867),M=a(972);class Q extends M.a{constructor(){super();
this.prevParentPath=null;this.H_=Object.assign(new H.a,{T_:Q.getTypeName(),B_:Q.Pd()})}static getTypeName(){return"AugLoop_Core_MoveOperation"}static Pd(){return["AugLoop_Core_OperationWithSiblingContext","AugLoop_Core_Operation"]}}Object(u.a)(Q,"MoveOperation",M.a,[]);var U=a(970);class Z extends T.a{constructor(){super();this.M_=null;this.H_=Object.assign(new H.a,{T_:Z.getTypeName(),B_:Z.Pd()})}static getTypeName(){return"AugLoop_Core_UpdateAnnotationMetaDataOperation"}static Pd(){return["AugLoop_Core_Operation"]}}
Object(u.a)(Z,"UpdateAnnotationMetaDataOperation",T.a,[]);var P=a(973);class S extends T.a{constructor(){super();this.isVisible=!1;this.H_=Object.assign(new H.a,{T_:S.getTypeName(),B_:S.Pd()})}static getTypeName(){return"AugLoop_Core_VisibilityOperation"}static Pd(){return["AugLoop_Core_Operation"]}}Object(u.a)(S,"VisibilityOperation",T.a,[]);var ja=a(715);class X extends ja.a{constructor(){super();this.bridgeId=this.cv=this.messageId=null;this.H_=Object.assign(new H.a,{T_:X.getTypeName(),B_:X.Pd()})}static getTypeName(){return"AugLoop_Session_Protocol_Message"}static Pd(){return[]}}
Object(u.a)(X,"Message",ja.a,[]);class Y extends X{constructor(){super();this.activeWorksheetId=null;this.H_=Object.assign(new H.a,{T_:Y.getTypeName(),B_:Y.Pd()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelKeepAlive"}static Pd(){return["AugLoop_Session_Protocol_Message"]}}Object(u.a)(Y,"ExcelKeepAlive",X,[]);class va extends L.a{constructor(){super();this.isObserverRequired=this.isSeedingRequired=!1;this.H_=Object.assign(new H.a,{T_:va.getTypeName(),B_:va.Pd()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ObserverStatusAnnotation"}static Pd(){return["AugLoop_Core_Annotation"]}}
Object(u.a)(va,"ObserverStatusAnnotation",L.a,[]);class N extends X{constructor(){super();this.parentPath=this.opType=this.seq=this.item=null;this.H_=Object.assign(new H.a,{T_:N.getTypeName(),B_:N.Pd()})}static getTypeName(){return"AugLoop_Session_Protocol_MicroSyncMessage"}static Pd(){return["AugLoop_Session_Protocol_Message"]}}Object(u.a)(N,"MicroSyncMessage",X,[]);class ea extends ja.a{constructor(){super();this.id=null;this.sizeBytes=0;this.dataPointer=this.data=null;this.H_=Object.assign(new H.a,
{T_:ea.getTypeName(),B_:ea.Pd()})}static getTypeName(){return"AugLoop_Core_Blob"}static Pd(){return[]}}Object(u.a)(ea,"Blob",ja.a,[]);class Ca extends ea{constructor(){super();this.format=0;this.otherFormat=null;this.size=0;this.isOriginalSize=null;this.H_=Object.assign(new H.a,{T_:Ca.getTypeName(),B_:Ca.Pd()})}static getTypeName(){return"AugLoop_Image_ImageContent"}static Pd(){return["AugLoop_Core_Blob"]}}Object(u.a)(Ca,"ImageContent",ea,[]);class la extends ja.a{constructor(){super();this.heightPx=
this.widthPx=0;this.H_=Object.assign(new H.a,{T_:la.getTypeName(),B_:la.Pd()})}static getTypeName(){return"AugLoop_Image_ImageTileMetadata"}static Pd(){return[]}}Object(u.a)(la,"ImageTileMetadata",ja.a,[]);class Ra extends la{constructor(){super();this.contents=null;this.H_=Object.assign(new H.a,{T_:Ra.getTypeName(),B_:Ra.Pd()})}static getTypeName(){return"AugLoop_Image_ImageTile"}static Pd(){return["AugLoop_Image_ImageTileMetadata"]}}Object(u.a)(Ra,"ImageTile",la,[]);var lb=a(99),Aa;(function(ta){ta[ta.unknown=
0]="unknown";ta[ta.fatal=1]="fatal";ta[ta.tokenExpired=2]="tokenExpired";ta[ta.modelWorkflowNotSupported=3]="modelWorkflowNotSupported"})(Aa||(Aa={}));Object(u.b)("ExcelSessionErrorType",Aa);class da{constructor(){this.annotations=new Set}Wxc(ta){this.SJ=ta;return this}activateAnnotation(ta){if(this.annotations.has(ta))throw ta=`Annotation from type ${ta.annotationType} was already activated`,e.ULS.sendTraceTag(521216417,0,10,`AugmentationLoopFeatureRegistrationInfoBuilder.activateAnnotation: ${ta}`),
Error(ta);this.annotations.add(ta);return this}iyc(ta){this.featureName=ta;return this}build(){if(void 0===this.SJ)throw e.ULS.sendTraceTag(521216416,0,10,"AugmentationLoopFeatureRegistrationInfoBuilder.build: Close callback is not set"),Error("Close callback is not set");if(0===this.annotations.size)throw e.ULS.sendTraceTag(521216415,0,10,"AugmentationLoopFeatureRegistrationInfoBuilder.build: No annotations were activated"),Error("No annotations were activated");if(!this.featureName)throw e.ULS.sendTraceTag(521216414,
0,10,"AugmentationLoopFeatureRegistrationInfoBuilder.build: Feature Name is not set"),Error("Feature Name is not set");return{featureName:this.featureName,SJ:this.SJ,annotations:this.annotations}}}Object(u.a)(da,"AugmentationLoopFeatureRegistrationInfoBuilder",null,[879]);class aa extends h.a{constructor(ta,wa,db,Jb=null){var Pb;super();this.Oma=null;this.isObserverRequired=!1;this.Re=null;this.Yjf=!0;this.asa=[];this.$ne=new Set;this.Eoc=[];this.Doc=new Map;this.e1b=[];this.zCh=new Map([[0,"Unknown"],
[1,"Permanent"],[2,"Permanent"],[3,"ModelWorkflowNotSupported"]]);this.yFc=new d;this.spd=v.EwaSettings.isChangeGateEnabled("OfficeVSO:7317668_AvoidSeveralModelWorkflowNotSupportedCloseReasons");this.Tc=(eb,Ma)=>{Ma.VH&&this.$.ea.sessionId&&(e.ULS.sendTraceTag(537170394,0,50,`AugmentationLoopManager.onSessionIdChanged: Update augmentation loop server on new ECS Session ID: '${this.$.ea.sessionId}'`),this.ZT.forceReconnectSession(Object(b.a)(new B,{excelServerParameters:Object(b.a)(new C,{wacCluster:this.$.va.MachineCluster,
ecsSessionId:this.$.ea.sessionId,ecsRestUrl:this.$.va.RestActionUrl,ecsOperationUrl:"",metadataVersion:0,serverEventVersion:0,permissionFlags:0,configurations:0,userListVersion:0,collabStateId:0,accessToken:this.$.va.AccessToken,accessTokenTTL:this.$.va.AccessTokenValidTo.toString()})})).catch(ob=>{e.ULS.sendTraceTag(526406272,0,50,`AugmentationLoopManager.onSessionIdChanged: forceReconnectSession promise rejected with error ${ob}`)}),e.ULS.sendTraceTag(528348225,0,50,`AugmentationLoopManager.onSessionIdChanged: sending ObserverRequiredNotification, isSeedingRequired: ${this.isObserverRequired}`),
this.MQd(this.isObserverRequired))};this.Soc=(eb,Ma,ob)=>{v.EwaSettings.isChangeGateEnabled("OfficeVSO:7271930_AddCloseReasonAndErrorCodeLogging")?e.ULS.sendTraceTag(509727633,0,50,`AugmentationLoopManager.onCloseMessage called with shouldRetry: ${eb}, errorType: ${Aa[Ma]}, errorCode: ${ob}`):e.ULS.sendTraceTag(520679431,0,50,"AugmentationLoopManager.onCloseMessage called");if(eb)if(this.ZT.startNewSession(),this.spd)this.pRf();else for(const Ia of this.asa)this.$ra(Ia);else this.asa.some(Ia=>!Ia.w_)||
this.tXd(),eb=this.yCh(Ma),this.o_g(eb,ob),this.$ze(),"ModelWorkflowNotSupported"===eb&&(this.spd&&(this.Yjf=!1),this.ZT.startNewSession(),this.spd?this.pRf():this.asa.filter(Ia=>!Ia.w_).forEach(Ia=>this.$ra(Ia))),v.EwaSettings.isChangeGateEnabled("OfficeVSO:5948479_QuickSavesWhenAloneForAugloop")&&this.$.ea.sessionId&&(e.ULS.sendTraceTag(520679430,0,50,"AugmentationLoopManager.onCloseMessage: sending ObserverRequiredNotification, isSeedingRequired: false"),this.MQd(!1))};this.yc=(eb,Ma)=>{if(Ma.Of)e.ULS.sendTraceTag(520677599,
0,50,"AugmentationLoopManager.onWorkbookClosing: event triggered due to silent reopen. Avoiding event with early return");else if(e.ULS.sendTraceTag(537170381,0,50,`AugmentationLoopManager.onWorkbookClosing: handler invoked
      (IsAppBeforeUnload == ${this.$.WMa}, IsAppUnloading == ${this.$.AD}.`),this.$.WMa||this.$.AD)this.tXd(),this.$ze(),this.ZT.closeSession().catch(ob=>{e.ULS.sendTraceTag(526406240,0,50,`AugmentationLoopManager.onWorkbookClosing: closeSession promise rejected with error ${ob}`)})};this.cHa=eb=>{e.ULS.sendTraceTag(537170380,0,50,"Annotation Received");if(eb)if(eb.items){var Ma;({value:Ma}=this.Oma.Dc(ja.a.ILa(eb),0));if(0===Ma)e.ULS.sendTraceTag(537170377,0,10,"AugmentationLoopManager.annotationCallback: Operation Type not supported "+
ja.a.ILa(eb));else{var ob=!0;for(const Da of eb.items){if(!Da){e.ULS.sendTraceTag(537170376,0,10,"AugmentationLoopManager.annotationCallback: Error in item");continue}if(!(ja.a.Nyd(eb,[D.getTypeName()])||Da.body&&this.Kji(Da.body))){e.ULS.sendTraceTag(537170375,0,10,"AugmentationLoopManager.annotationCallback: Body is either null or not an annotation.");continue}if(v.EwaSettings.isChangeGateEnabled("OfficeVSO:6530013_FilterOutAnnotationsAccordingToOwner")){var Ia=Da.source;if(this.e1b.includes(Ia)){e.ULS.sendTraceTag(520677597,
0,50,`AugmentationLoopManager.annotationCallback: Filtered out annotation of owner ${Ia}`);continue}}Ia=ja.a.ILa(Da.body);if(!Ia){e.ULS.sendTraceTag(523329624,0,50,"AugmentationLoopManager.annotationCallback: annotationType is null");continue}const nb=Da.body;if(!nb){e.ULS.sendTraceTag(523329623,0,50,"AugmentationLoopManager.annotationCallback: annotation is null");continue}const Ua=new r(nb,null,eb.parentPath,Ma);ob=this.hDj(nb)&&ob;e.ULS.sendTraceTag(576271178,0,50,`AugmentationLoopManager.annotationCallback: Triggering Event handler for Annotation ${Ia}. Should report: ${ob}. ParentRevId: ${eb.parentRevId}`);
this.U1b.npi(Ua.FM.id,eb.parentRevId)&&(this.raiseEvent(this.Ayd(Ia),Ua,this),e.ULS.sendTraceTag(520677596,0,100,`AugmentationLoopManager.annotationCallback: raising newAnnotation event (annotation type: ${Ia})`));this.U1b.kCd(Ia,Ua,eb.parentRevId);this.raiseEvent(Ia,Ua,this)}this.klc&&ob&&(eb=t.a(this.Ph,this.klc.c2d),e.ULS.sendTraceTag(590906632,0,50,`AugmentationLoopManager.annotationCallback: Got valid annotation, time elapse from last state id(${this.klc.stateId}): ${eb}`))}}else e.ULS.sendTraceTag(537170378,
0,10,"AugmentationLoopManager.annotationCallback: Operation has no items");else e.ULS.sendTraceTag(537170379,0,10,"AugmentationLoopManager.annotationCallback: Operation is null")};this.Ay=(eb,Ma)=>{-1!==Ma.bxf&&(this.klc=Object(b.a)(new n,{stateId:Ma.bxf,c2d:this.Ph.zb}))};this.Jma=()=>{const eb=t.b(this.Ph,this.VCb),Ma=this.$.ea.S4,ob=this.$.ea.m1;this.Ivf<=eb&&ob<this.xUa&&!Ma?(this.VCb=this.Ph.zb,e.ULS.sendTraceTag(520677595,0,50,`AugmentationLoopManager.onUserActivityThrottled: Submitting keepalive custom message. secondsSinceLastKeepAlive: ${eb}, timeInSecFromLastStatefulSuccessfulRequest: ${ob}, deploymentOrTimedOutError: ${Ma}`),
this.ZT.submitCustomMessage(Object(b.a)(new E,{message:new Y})).catch(Ia=>{e.ULS.sendTraceTag(526406239,0,50,`AugmentationLoopManager.onUserActivityThrottled: submitCustomMessage promise rejected with error ${Ia}`)})):this.Ivf<=eb&&e.ULS.sendTraceTag(520632032,0,50,`AugmentationLoopManager.onUserActivityThrottled: Not submitting keepalive custom message. secondsSinceLastKeepAlive: ${eb}, timeInSecFromLastStatefulSuccessfulRequest: ${ob}, deploymentOrTimedOutError: ${Ma}`)};this.eyf=(eb,Ma)=>{eb=Ma.FM;
e.ULS.shipAssertTag(537170373,306,!!eb,"AugmentationLoopManager.ObserverStatusAnnotationHandler: ObserverStatusAnnotation is null.");e.ULS.sendTraceTag(520677594,0,50,`AugmentationLoopManager.observerStatusAnnotationHandler: received ${JSON.stringify(eb)}`);this.isObserverRequired=eb.isSeedingRequired&&eb.isObserverRequired;this.$.ea.sessionId&&(e.ULS.sendTraceTag(520677593,0,50,`AugmentationLoopManager.observerStatusAnnotationHandler: sending ObserverRequiredNotification, isObserverRequired: ${this.isObserverRequired}`),
this.MQd(this.isObserverRequired))};this.zRb=(eb,Ma)=>{var ob;(null===(ob=null===Ma||void 0===Ma?void 0:Ma.nd)||void 0===ob?0:ob.WorkbookCoauthVersion)&&this.MZi(Ma.nd.WorkbookCoauthVersion,Ma.context)};this.Ph=Jb||y.a.Qa;this.VCb=this.Ph.zb;this.$=ta;this.ZT=wa;this.U1b=db;e.ULS.sendTraceTag(520679433,0,50,`AugmentationLoopManager.constructor: setAnnotationResultCallback : ${null===(Pb=this.cHa)||void 0===Pb?void 0:Pb.name}`);this.ZT.setAnnotationResultCallback(Object(b.a)(new A,{handler:this.cHa}));
this.Ofi();this.$.ea.OE(this.Ay);this.$.Xj(this.yc);this.klc=Object(b.a)(new n,{stateId:0,c2d:this.Ph.zb});this.$.da.Ga(328,this);this.Ivf=this.$.va.MinimumSecondsBetweenKeepAlivesFromBrowserToAugloop;this.xUa=60*this.$.va.UserActiveTimeSinceLastActivityInMinutes;this.$.ea.Wj(this.Tc);this.$.pa.Kq(this.zRb);v.EwaSettings.isChangeGateEnabled("OfficeVSO:6530013_FilterOutAnnotationsAccordingToOwner")&&this.Adi();this.cGg();this.UFg()}Adi(){v.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableLintBatchLoad",
!1)?this.e1b.push("TableLint-Grid-Column"):this.e1b.push("Tablelint-Column");v.EwaSettings.isChangeGateEnabled("OfficeVSO:7001231_IgnoreXlimVNextAnnotations")&&this.e1b.push("ExcelTableRecognitionReducer")}Lbc(){return new da}register(ta){this.Doc.set(ta.featureName,ta.SJ);for(const wa of ta.annotations)this.$ra(Object.assign(Object.assign({},wa),{featureName:ta.featureName})),wa.mPa&&this.Mpe(wa.annotationType,wa.mPa),wa.bRb&&this.cpb.Zga("Valid",wa.annotationType,wa.bRb),wa.Sod&&this.cpb.Zga("Invalid",
wa.annotationType,wa.Sod)}unregister(ta){this.Doc.delete(ta);this.asa.filter(wa=>wa.featureName===ta).forEach(wa=>{wa.mPa&&this.pfj(wa.annotationType,wa.mPa);wa.bRb&&this.cpb.IJb("Valid",wa.annotationType,wa.bRb);wa.Sod&&this.cpb.IJb("Invalid",wa.annotationType,wa.Sod)})}$oe(ta){this.Eoc.push(ta);e.ULS.sendTraceTag(520679432,0,50,`AugmentationLoopManager.addCloseCallback: ${null===ta||void 0===ta?void 0:ta.name}`)}yCh(ta){var wa;return null!==(wa=this.zCh.get(ta))&&void 0!==wa?wa:"Unknown"}pRf(){this.Yjf?
this.asa.forEach(ta=>this.$ra(ta)):this.asa.filter(ta=>!ta.w_).forEach(ta=>this.$ra(ta))}Ayd(ta){return`New_${ta}ALManager`}Mpe(ta,wa){e.ULS.sendTraceTag(520679429,0,50,`AugmentationLoopManager.addNewAnnotationCallback: annotationType: ${ta}, handler: ${null===wa||void 0===wa?void 0:wa.name}`);this.addHandler(this.Ayd(ta),wa)}pfj(ta,wa){this.removeHandler(this.Ayd(ta),wa)}Zga(ta,wa){e.ULS.sendTraceTag(520679428,0,50,`AugmentationLoopManager.addAnnotationCallback: annotationType: ${ta}, handler: ${null===
wa||void 0===wa?void 0:wa.name}`);this.addHandler(ta,wa)}IJb(ta,wa){this.removeHandler(ta,wa)}bpe(ta){e.ULS.sendTraceTag(520679427,0,50,"AugmentationLoopManager.addCoauthVersionChangedCallback");this.addHandler("CoauthVersionChangedALManager",ta)}dUf(ta){e.ULS.sendTraceTag(520679426,0,50,"AugmentationLoopManager.removeCoauthVersionChangedCallback called");this.removeHandler("CoauthVersionChangedALManager",ta)}activateAnnotation(ta,wa=null){e.ULS.sendTraceTag(537170390,0,50,`AugmentationLoopManager.activateAnnotation: activating annotation type: ${ta}.`);
this.$ne.has(ta)&&e.ULS.sendTraceTag(537170389,0,50,`AugmentationLoopManager.activateAnnotation: Annotations ${ta} were already activated in client session.`);this.$ne.add(ta);this.Re||(this.Re=this.$.ea.Re,this.Re.hha(this.Jma));this.ZT.activateAnnotation(Object(b.a)(new w,{annotationType:ta,stateUpdateHandler:wa})).then(db=>{db||e.ULS.sendTraceTag(537170388,0,10,"AugmentationLoopManager.activateAnnotation: ActivateAnnotationsResult is null");return null}).catch(db=>{e.ULS.sendTraceTag(526406243,
0,50,`AugmentationLoopManager.activateAnnotation: activateAnnotation promise rejected with error ${db}`)})}$ra(ta){e.ULS.sendTraceTag(520679425,0,50,`AugmentationLoopManager.activateAnnotation: activating annotation type: ${ta.annotationType}.`);this.asa.includes(ta)?e.ULS.sendTraceTag(520679424,0,50,`AugmentationLoopManager.activateAnnotation: Annotations ${ta.annotationType} were already activated in client session.`):this.asa.push(ta);this.Re||(this.Re=this.$.ea.Re,this.Re.hha(this.Jma));v.EwaSettings.isChangeGateEnabled("OfficeVSO:6044361_XLALCatchPromiseFailures")?
this.ZT.activateAnnotation(Object(b.a)(new w,{annotationType:ta.annotationType,stateUpdateHandler:ta.Ste})).then(wa=>{wa||e.ULS.sendTraceTag(520677603,0,10,"AugmentationLoopManager.activateAnnotation: ActivateAnnotationsResult is null");return null}).catch(wa=>{e.ULS.sendTraceTag(520677602,0,50,`AugmentationLoopManager.activateAnnotation: activateAnnotation promise rejected with error ${wa}`)}):this.ZT.activateAnnotation(Object(b.a)(new w,{annotationType:ta.annotationType,stateUpdateHandler:ta.Ste})).then(wa=>
{wa||e.ULS.sendTraceTag(520677601,0,10,"AugmentationLoopManager.ActivateAnnotation: ActivateAnnotationsResult is null");return null})}submitOperation(ta){e.ULS.shipAssertTag(537170387,0,!!ta,"AugmentationLoopManager.submitOperation: operation is null");e.ULS.sendTraceTag(537170386,0,50,`AugmentationLoopManager.submitOperation: submitting operation of type '${ja.a.ILa(ta)}'`);this.ZT.submitOperation(Object(b.a)(new I,{operation:ta}))}MXd(ta){e.ULS.shipAssertTag(537170385,0,!!ta,"AugmentationLoopManager.submitOperationSignal: signal is null");
const wa=Object.getTypeName(ta);e.ULS.sendTraceTag(537170384,0,50,`AugmentationLoopManager.submitOperationSignal: submitting operation signal of type '${wa}'`);this.ZT.submitOperation(Object(b.a)(new I,{operation:Object(b.a)(new U.a,{parentPath:["Signal",Object.getTypeName(ta)],items:[Object(b.a)(new J.a,{body:ta})]})}))}registerLocalWorkflow(ta){e.ULS.shipAssertTag(537170383,0,!!ta,"AugmentationLoopManager.registerLocalWorkflow: workflow is null");e.ULS.sendTraceTag(537170382,0,50,`AugmentationLoopManager.registerLocalWorkflow: registering local workflow '${ta.id}'`);
this.ZT.registerLocalWorkflow(Object(b.a)(new z,{workflow:ta}))}p_j(ta,wa,db,Jb){ta=Object(b.a)(new Ra,{heightPx:Jb,widthPx:db,contents:[Object(b.a)(new Ca,{id:wa+".0",format:2,size:3,sizeBytes:ta.length,data:ta})]});wa=Object(b.a)(new J.a,{id:wa,body:ta});wa=Object(b.a)(new N,{item:wa});e.ULS.sendTraceTag(520677600,0,50,"AugmentationLoopManager.uploadImage: submitting custom message");this.ZT.submitCustomMessage(Object(b.a)(new E,{message:wa})).catch(Pb=>{e.ULS.sendTraceTag(526406241,0,50,`AugmentationLoopManager.uploadImage: submitCustomMessage promise rejected with error ${Pb}`)})}get cpb(){return this.U1b}dispose(){this.$&&
this.$.ea&&this.$.ea.tk(this.Tc);this.$&&this.$.pa&&this.$.pa.Mr(this.zRb);this.Eoc=[];this.Doc.clear();this.tXd();super.dispose()}tXd(){this.Re&&(this.Re.BAa(this.Jma),this.Re=null);this.$.ea.cE(this.Ay)}$ze(){for(let ta of this.Eoc)try{ta()}catch(wa){e.ULS.sendTraceTag(528016151,0,10,`AugmentationLoopManager.callAndClearAugloopCloseCallbacks: exception thrown at callback invocation with message: ${wa.message}`)}this.Eoc=[]}o_g(ta,wa){for(const db of this.Doc.values())try{db(ta,wa)}catch(Jb){e.ULS.sendTraceTag(520677598,
0,10,String.format(`AugmentationLoopManager.callAndClearAugloopCloseCallbacks: exception thrown at callback invocation with message: ${Jb.message}`))}}Ofi(){this.Oma=new lb.a;this.Oma.ia(V.a.getTypeName(),1);this.Oma.ia(P.a.getTypeName(),2);this.Oma.ia(Q.getTypeName(),5);this.Oma.ia(D.getTypeName(),3);this.Oma.ia(S.getTypeName(),7);this.Oma.ia(G.getTypeName(),6);this.Oma.ia(Z.getTypeName(),4)}Kji(ta){return ja.a.ILa(ta)===L.a.getTypeName()||0<=Array.indexOf(ja.a.v0e(ta),L.a.getTypeName())}hDj(ta){if(ta){if(v.EwaSettings.getBooleanFeatureGate("Microsoft.Office.SharedOnline.AutoCLPV2Transition",
!1)){var wa=!!ta.recommended&&!!ta.recommended.id;return!!ta.automatic&&!!ta.automatic.id||wa}wa=!!ta.recommended&&!!ta.recommended.sensitivityLabel&&!!ta.recommended.sensitivityLabel.id;return!!ta.automatic&&!!ta.automatic.sensitivityLabel&&!!ta.automatic.sensitivityLabel.id||wa}return!1}UFg(){v.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UnitTelemetryAL",!1)&&this.$ra({annotationType:"AugLoop_UnitTelemetry_UnitTelemetryAggregatedAnnotation",w_:!0});v.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TablelintComparison",
!1)&&this.$ra({annotationType:"AugLoop_Excel_ExcelComparisonAnnotation",w_:!0})}cGg(){this.$ra({annotationType:va.getTypeName(),w_:!0,mPa:this.eyf});this.Mpe(va.getTypeName(),this.eyf)}MQd(ta){x(this.$.pa.ya,ta,null,null,null,null)}MZi(ta,wa){if(this.yFc.DocId!==ta.DocId||this.yFc.Xluid!==ta.Xluid&&this.yFc.Xrevid!==ta.Xrevid)this.yFc=ta,this.raiseEvent("CoauthVersionChangedALManager",{coauthVersion:ta,userContext:wa},this),this.U1b.LZi(ta,wa.userContext)}}Object(u.a)(aa,"AugmentationLoopManager",
h.a,[864,2]);var fa=a(4),Oa=a(386),ba=a(196),ka=a(147),Pa=a(30),Fa=a(83),oa=a(52);class La{constructor(){this.syncDeltaTimeout=this.disableSyncDeltaSending=this.isDeltaGeneratorEnabled=this.powerpoint=this.downloadPolymerBaseUrl=this.inferenceServiceVersion=this.downloadBaseUrl=this.sessionCreationOptions=this.disabledServiceGroups=this.privateMode=this.flights=this.excelServer=this.initSession=this.sessionId=this.releaseFork=this.releaseCustomAudience=this.releaseChannel=this.releaseAudienceGroup=
this.uiLanguage=this.appVersion=this.appName=this.serviceUrl=null}}Object(u.a)(La,"InitializeParameters",null,[]);class Ea{constructor(){this.enableRemoteExecutionNotification=this.networkMode=this.egress=this.localRegisteredWorkflows=this.enableComplexLocalWorkflows=this.serviceUrl=this.onServerAuthenticationStateChangeCallback=this.onSessionClose=this.onSessionReconnect=this.onSessionDisconnect=this.onSessionConnect=this.flights=this.extensionConfigs=this.docSessionId=null}}Object(u.a)(Ea,"SessionCreationOptions",
null,[]);class ca{constructor(){this.featureEnabledCallback=null}}Object(u.a)(ca,"SetIsFeatureEnabledCallbackParameters",null,[]);class $a{constructor(){this.requestAuthTokenCallback=null}}Object(u.a)($a,"SetRequestAuthTokenCallbackParameters",null,[]);class Qa{constructor(){this.sendOTelEvent=null}}Object(u.a)(Qa,"SetSendOTelEventCallbackParameters",null,[]);class Va{constructor(){this.handler=null}}Object(u.a)(Va,"SetSessionInitOverrideCallbackParameters",null,[]);class fb{constructor(){this.ulsLogger=
null}}Object(u.a)(fb,"SetULSLoggerParameters",null,[]);class Ka extends ja.a{constructor(){super();this.activeWorksheetId=this.supportCustomMessages=this.accessTokenTTL=this.accessToken=this.collabStateId=this.collabUserListVersion=this.configurations=this.permissionFlags=this.serverEventVersion=this.workbookMetadataVersion=this.ecsOperationUrl=this.restUrl=this.ecsId=this.cluster=null;this.H_=Object.assign(new H.a,{T_:Ka.getTypeName(),B_:Ka.Pd()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelServerSessionExtensionConfig"}static Pd(){return[]}}
Object(u.a)(Ka,"ExcelServerSessionExtensionConfig",ja.a,[]);var hb=a(866),fc=a(185);class dc{static $xi(ta,wa,db){if(dc.T1b)return e.ULS.sendTraceTag(537170369,0,15,"augloop: LoadAndInitializeAugLoopRuntimeManager called more than once"),dc.T1b;const Jb=fa.AFrameworkApplication.fa.Xa("AugLoopCloudALServiceUrl");if(!Jb||!Jb.length)return e.ULS.sendTraceTag(537170368,0,15,"AugmentationLoopRuntimeProxy.LoadAndInitializeAugLoopRuntimeManager: AugLoopCloudALServiceUrl is null or empty"),Promise.reject(null);
db=fc.a(oa.a.loadScript(83,4,db,void 0,void 0,327));dc.T1b=db.then(()=>{const Pb=augLoop.ALFactoryGlobal.getAugLoopRuntimeManager();dc.Gei(ta,wa,Pb);return Promise.resolve(Pb)}).catch(Pb=>{e.ULS.sendTraceTag(537170339,0,10,"augloop: Failed to download script:"+Pb);return Promise.reject(null)});return dc.T1b}static Gei(ta,wa,db){var Jb;e.ULS.sendTraceTag(537170338,0,50,"augloop: Successfully loaded script");dc.Ph||dc.Fuj(y.a.Qa);dc.Mqd=new Set;e.ULS.sendTraceTag(522803219,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: setIsFeatureEnabledCallback");
db.setIsFeatureEnabledCallback(Object(b.a)(new ca,{featureEnabledCallback:eb=>{const Ma=fa.AFrameworkApplication.fa.qa("AugLoop"+eb),ob=v.EwaSettings.getBooleanFeatureGate(eb,!1),Ia=v.EwaSettings.getBooleanFeatureGate("AugLoop"+eb,!1),Da=ob||Ia,nb=Ma||Da;dc.Mqd.has(eb)||(dc.Mqd.add(eb),e.ULS.shipAssertTag(537170337,0,!(Ma&&!Da),`AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager.isFeatureEnabled: legacy app setting return true for feature ${eb}, but feature gate return false. This is problem because app setting is depricated and about to be removed`),
nb&&e.ULS.sendTraceTag(537170336,0,50,`AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager.isFeatureEnabled: feature ${eb} is enabled. legacyAppSettingResult: ${Ma}, featureGateWithoutPrefix: ${ob}, featureGateWithPrefix: ${Ia}`));return nb}}));if(v.EwaSettings.ma(426))if(wa){var Pb=dc.Mbc(wa);Pb=dc.Mbc(wa,fa.AFrameworkApplication.fa.Xa("AugloopACLPUserDataSignature"));e.ULS.sendTraceTag(522803218,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: Callback is passed to the augloop runtime which calls the code  when an auth token is required");
db.setRequestAuthTokenCallback(Object(b.a)(new $a,{requestAuthTokenCallback:Pb}))}else e.ULS.sendTraceTag(537170335,0,10,"Oauth manager is null");e.ULS.sendTraceTag(522803217,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setULSLogger");db.setULSLogger(Object(b.a)(new fb,{ulsLogger:new Oa.a}));e.ULS.sendTraceTag(522803216,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setSendOTelEventCallback");db.setSendOTelEventCallback(Object(b.a)(new Qa,
{sendOTelEvent:dc.sendOTelEvent}));wa="";Pb=new Map;if(v.EwaSettings.isChangeGateEnabled("OfficeVSO:7126168_passFlightsToAL")){const eb=v.EwaSettings.kTh();for(const [Ma,ob]of eb)Pb.set(Ma,String(ob))}v.EwaSettings.ma(428)&&(wa+="AugmentationLoopObserverSession;",Pb.set("AugmentationLoopObserverSession",void 0));v.EwaSettings.ma(478)&&(wa+="AugmentationLoopIncrementalUpdates;",Pb.set("AugmentationLoopIncrementalUpdates",void 0));v.EwaSettings.ma(434)&&(wa+="EnterpriseDataTypeMipSupport;",Pb.set("EnterpriseDataTypeMipSupport",
void 0));if(v.EwaSettings.getBooleanFeatureGate("Microsoft.Office.ExcelOnline.TableLintExperiment",!1)||v.EwaSettings.getBooleanFeatureGate("Microsoft.Office.ExcelOnline.TableLintProdExperiment",!1)||v.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableIntelligence",!1)||v.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UnitTelemetryAL",!1))wa+="LoadAdditionalDataToModel;",Pb.set("LoadAdditionalDataToModel",void 0);v.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.DataCleansingTaskPane",
!1)&&(wa+="DataCleansingSlice0;LoadAdditionalDataToModel;",Pb.set("DataCleansingSlice0",void 0),Pb.set("LoadAdditionalDataToModel",void 0));v.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugloopNoLatency",!1)&&(wa+="AugloopNoLatency;",Pb.set("AugloopNoLatency",void 0));v.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableLintInvestigationTelemetry",!1)&&(wa+="TableLintInvestigationTelemetry;",Pb.set("TableLintInvestigationTelemetry",void 0));v.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TelemetryWorkflowIncludeTextHints",
!1)&&(wa+="TelemetryWorkflowIncludeTextHints;",Pb.set("TelemetryWorkflowIncludeTextHints",void 0));v.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.Insights.UseTableRecoMLTableIntelligence",!1)&&(wa+="UseTableRecoMLTableIntelligence;",Pb.set("UseTableRecoMLTableIntelligence",void 0));v.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableIntelligenceLogging",!1)&&(wa+="TableIntelligenceLogging;",Pb.set("TableIntelligenceLogging",void 0));v.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugloopWaitForWorkbookChangeState",
!1)&&(wa+="AugloopWaitForWorkbookChangeState;",Pb.set("AugloopWaitForWorkbookChangeState",void 0));v.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.XLALReadMetadataFromUserEcsSession",!1)&&(wa+="XLALReadMetadataFromUserEcsSession;",Pb.set("XLALReadMetadataFromUserEcsSession",void 0));v.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UseTableSenseML",!1)&&(wa+="UseTableSenseML;",Pb.set("UseTableSenseML",void 0));v.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableIntelligenceSheetCountThreshold",
!1)&&(null===(Jb=null===ta||void 0===ta?void 0:ta.xa)||void 0===Jb?0:Jb.count)&&ta.xa.count>v.EwaSettings.getIntFeatureGate("Microsoft.Office.Excel.TableIntelligenceSheetCountThresholdValue",100)&&(wa+="TableIntelligenceSheetCountThreshold;",Pb.set("TableIntelligenceSheetCountThreshold",void 0),e.ULS.sendTraceTag(521151777,306,50,`TableIntelligence max sheet count exceeded. SheetCount: ${ta.xa.count}`));Jb=v.EwaSettings.fSh();for(const eb of Jb)wa+=`${eb}=false;`,Pb.set(eb,"false");e.ULS.sendTraceTag(522803215,
0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setInitSessionCallback");db.setInitSessionCallback({initSessionCallback:()=>{var eb;if(null===(eb=null===ta||void 0===ta?void 0:ta.ea)||void 0===eb?0:eb.sessionId)return e.ULS.sendTraceTag(527708568,0,50,`AugmentationLoopRuntimeProxy.setInitSessionCallback: initSessionCallback called, sessionId is valid (length = ${ta.ea.sessionId.length}), return resolved promise`),Promise.resolve();e.ULS.sendTraceTag(527708567,0,
50,"AugmentationLoopRuntimeProxy.setInitSessionCallback: initSessionCallback called, sessionId is not valid, return promise that will be resolved when session id will be valid again.");return new Promise(Ma=>{var ob;const Ia=()=>{var Da;(null===(Da=null===ta||void 0===ta?void 0:ta.ea)||void 0===Da?0:Da.sessionId)?(e.ULS.sendTraceTag(527708566,0,50,`AugmentationLoopRuntimeProxy.setInitSessionCallback: sessionId changed callback called with valid session id (length = ${ta.ea.sessionId.length}), resolve the promise and unregister the callback.`),
ta.ea.tk(Ia),Ma()):e.ULS.sendTraceTag(527708565,0,50,"AugmentationLoopRuntimeProxy.setInitSessionCallback: sessionId changed callback called, but the session id is not valid yet, keep waiting.")};null===(ob=null===ta||void 0===ta?void 0:ta.ea)||void 0===ob?void 0:ob.Wj(Ia)})}});e.ULS.sendTraceTag(522803214,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setSessionInitOverrideCallback");db.setSessionInitOverrideCallback(Object(b.a)(new Va,{handler:eb=>{eb.extensionConfigs=
[Object(b.a)(new Ka,{cluster:ta.va.MachineCluster,ecsId:dc.ESh(ta),restUrl:ta.va.RestActionUrl,ecsOperationUrl:"",workbookMetadataVersion:0,serverEventVersion:0,permissionFlags:0,configurations:0,collabUserListVersion:0,collabStateId:0,accessToken:ta.va.AccessToken,accessTokenTTL:ta.va.AccessTokenValidTo.toString()})];e.ULS.sendTraceTag(537170334,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: access token TTL "+ta.va.AccessTokenValidTo.toString());return eb}}));e.ULS.sendTraceTag(522803213,
0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.initialize - onSessionClose: getOnCloseMessageCallback ");db.initialize(Object(b.a)(new La,{serviceUrl:fa.AFrameworkApplication.fa.Xa("AugLoopCloudALServiceUrl"),appName:"Excel",appVersion:fa.AFrameworkApplication.fa.Xa("BuildVersion")||"",releaseAudienceGroup:fa.AFrameworkApplication.Qb?Object(Fa.a)(String,fa.AFrameworkApplication.Qb.AudienceGroup)||"":"",releaseChannel:null,releaseFork:null,sessionId:ta.va.UserSessionId,
initSession:!0,flights:v.EwaSettings.isChangeGateEnabled("OfficeVSO:7126168_passFlightsToAL")?this.f9g(Pb):wa,uiLanguage:fa.AFrameworkApplication.uiCulture,excelServer:null,sessionCreationOptions:Object(b.a)(new Ea,{onSessionClose:dc.wYh()})}))}static f9g(ta){return Array.from(ta.entries()).map(([wa,db])=>void 0!==db?`${wa}:${db}`:wa).map(wa=>wa+";").join("")}static wYh(){return ta=>{let wa=!ba.a.instance.lR(fa.AFrameworkApplication.yk);const db=null===ta||void 0===ta?void 0:ta.reason;wa?ta?ta.reason?
v.EwaSettings.isChangeGateEnabled("OfficeVSO:7383152_deprecateIsRetryableError")?(e.ULS.shipAssertTag(509682979,0,!(void 0===db.isRetryableError||null===db.isRetryableError),"AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: closeReason.errorType is null"),wa&&(wa=null==db.errorType||2===db.errorType)):(e.ULS.shipAssertTag(537170333,0,!(void 0===db.isRetryableError||null===db.isRetryableError),"AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: closeReason.IsRetryableError is null"),wa=
(null==db.isRetryableError?!0:db.isRetryableError)&&wa):v.EwaSettings.isChangeGateEnabled("OfficeVSO:7271930_AddCloseReasonAndErrorCodeLogging")||e.ULS.sendTraceTag(537170332,0,15,"AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: closeMessage.Reason is null"):e.ULS.shipAssertTag(537170331,0,!1,"AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: - closeMessage is null"):e.ULS.sendTraceTag(537170330,0,15,"AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: access token has expired");
v.EwaSettings.isChangeGateEnabled("OfficeVSO:7271930_AddCloseReasonAndErrorCodeLogging")?v.EwaSettings.isChangeGateEnabled("OfficeVSO:7383152_deprecateIsRetryableError")?e.ULS.sendTraceTag(509727632,0,50,`AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: is called with shouldRetry: ${wa},
            errorType: ${null===db||void 0===db?void 0:db.errorType},
            errorCode: ${null===db||void 0===db?void 0:db.errorCode},
            isExpected: ${null===db||void 0===db?void 0:db.isExpected}`):e.ULS.sendTraceTag(509682978,0,50,`AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: is called with shouldRetry: ${wa},
            errorType: ${null===db||void 0===db?void 0:db.errorType},
            errorCode: ${null===db||void 0===db?void 0:db.errorCode},
            isExpected: ${null===db||void 0===db?void 0:db.isExpected},
            isRetryableError: ${null===db||void 0===db?void 0:db.isRetryableError}`):e.ULS.sendTraceTag(537170329,0,15,`AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: On close message callback is called. shouldRetry is set to ${wa}`);wa&&((!dc.wPb||t.a(dc.Ph,dc.wPb)>dc.$Rf)&&dc.Slj(),dc.Itc<dc.Uyd?(dc.Itc++,e.ULS.sendTraceTag(537170328,0,50,`AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: Start new session attempt ${dc.Itc} of ${dc.Uyd}. Time of first attempt in this interval of reconnects: ${dc.wPb}`)):
(e.ULS.sendTraceTag(537170327,0,15,`AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: Reached the limit of ${dc.Uyd} attempts for session creation under interval of ${dc.$Rf} Ms. Stop trying to reconnect. Time of first attempt in this iterval: ${dc.wPb}.`),wa=!1));dc.wAf(wa,null===db||void 0===db?void 0:db.errorType,null===db||void 0===db?void 0:db.errorCode)}}static Guj(ta){dc.wAf=ta}static Fuj(ta){dc.Ph=ta}static Slj(){dc.Itc=0;dc.wPb=dc.Ph.zb}static Mbc(ta,wa=""){return()=>{try{return e.ULS.sendTraceTag(527970953,
0,50,`AugmentationLoopRuntimeProxy.getAuthTokenDelegate: called with fallbackValue.length: ${wa.length}.`),ta.UL("AugLoop",fa.AFrameworkApplication.fa.Xa("AugLoopOAuthResourceUriV2")).then(db=>{if(db.IsSuccess)return e.ULS.sendTraceTag(527970952,0,50,"AugmentationLoopRuntimeProxy.getAuthTokenDelegate: successfully fetch token."),db.Token;e.ULS.sendTraceTag(537170326,0,15,`AugmentationLoopRuntimeProxy.getAuthTokenDelegate: failed to get token, use fallback value (length: ${wa.length})`);return wa},
()=>{e.ULS.sendTraceTag(537170325,0,15,"AugmentationLoopRuntimeProxy.getAuthTokenDelegate: got rejected promise, use fallback value");return wa})}catch(db){return e.ULS.sendTraceTag(537170324,0,10,"Exception thrown when fetching token"),Promise.resolve(wa)}}}static sendOTelEvent(ta){ka.a.sendOtelEvent(Object(b.a)(new hb.a,{otelEvent:ta}))}static ESh(ta){const wa=Pa.a.mf(ta.ea.sessionId);ta=`cluster=${ta.va.MachineCluster}&session=${wa}&usid=${ta.va.UserSessionId}`;v.EwaSettings.isChangeGateEnabled("OfficeVSO:5897059_XLALInvestigateIncorrectSessionId")&&
e.ULS.sendTraceTag(528348230,0,50,`AugmentationLoopRuntimeProxy.getEcsSessionId: ecsSessionId length is ${ta.length}`);return ta}}dc.Uyd=3;dc.$Rf=3E5;dc.Itc=0;dc.wPb=null;dc.Ph=null;dc.T1b=null;dc.wAf=null;dc.Mqd=null;Object(u.a)(dc,"AugmentationLoopRuntimeProxy",null,[]);var wb=a(49),Tb=a(37),xb=a(189),cb;(function(ta){ta.newAnnotation="New";ta.validAnnotation="Valid";ta.invalidAnnotation="Invalid"})(cb||(cb={}));Object(u.b)("AnnotationCallbackType",cb);var jb;(function(ta){ta.newAnnotation="New";
ta.validOnArrivalAnnotation="ValidOnArrival";ta.validAfterSomeTimeAnnotation="ValidAfterSomeTime";ta.invalidOnCoauthVersionChangedAnnotation="InvalidOnCoauthVersionChanged";ta.invalidAfterTimeoutAnnotation="InvalidAfterTimeout"})(jb||(jb={}));Object(u.b)("AnnotationEventType",jb);var qa;(function(ta){ta[ta.beforeAnnotation=0]="beforeAnnotation";ta[ta.atAnnotation=1]="atAnnotation";ta[ta.afterAnnotation=2]="afterAnnotation"})(qa||(qa={}));Object(u.b)("TimelinePosition",qa);class za{constructor(){this.Mfb=
new Map;e.ULS.sendTraceTag(520176320,0,50,"AugmentationLoopAnnotationValidatorLogger.constructor: called")}Roe(ta){this.Mfb.has(ta)||(e.ULS.sendTraceTag(520176291,0,50,`AugmentationLoopAnnotationValidatorLogger.addAnnotationType: ${ta}`),this.Mfb.set(ta,[]))}Aej(ta){this.Mfb.delete(ta)&&e.ULS.sendTraceTag(520176290,0,50,`AugmentationLoopAnnotationValidatorLogger.removeAnnotationType: ${ta}`)}mUi(ta,wa){ta.find(db=>db.annotationId===wa)||ta.push({annotationId:wa,QPj:Date.now(),c1b:jb.newAnnotation})}FAi(ta,
wa,db,Jb){e.ULS.sendTraceTag(520176289,0,50,`AugmentationLoopAnnotationValidatorLogger.logLatencyEntry: type: ${ta}, entry: (${wa.annotationId} ${wa.c1b}) incoming: ${Jb}, latency: ${db-wa.QPj} ms`)}F$h(ta,wa,db){return(db===jb.validAfterSomeTimeAnnotation||db===jb.validOnArrivalAnnotation)&&(ta.annotationId===wa||ta.c1b===jb.invalidAfterTimeoutAnnotation)}UYi(ta,wa,db,Jb){let Pb=[];const eb=Date.now();let Ma=qa.beforeAnnotation;for(let ob of wa){this.F$h(ob,db,Jb)&&this.FAi(ta,ob,eb,Jb);if(ob.annotationId===
db){ob.c1b=Jb;if(Jb===jb.invalidAfterTimeoutAnnotation)return;Ma=qa.atAnnotation}else Ma===qa.atAnnotation&&(Ma=qa.afterAnnotation);wa=Jb===jb.invalidOnCoauthVersionChangedAnnotation?ob.annotationId!==db:ob.c1b===jb.newAnnotation;const Ia=Ma===qa.afterAnnotation;(Ma!==qa.afterAnnotation&&wa||Ia)&&Pb.push(ob)}this.Mfb.set(ta,Pb)}qLi(ta,wa,db){let Jb=this.Mfb.get(ta);Jb||(this.Roe(ta),Jb=this.Mfb.get(ta));db===jb.newAnnotation?this.mUi(Jb,wa):this.UYi(ta,Jb,wa,db)}}Object(u.a)(za,"AugmentationLoopAnnotationValidatorLogger",
null,[]);class Na{constructor(ta,wa){this.toString=()=>JSON.stringify(this);this.annotationId=ta;this.coauthVersion=wa}}Object(u.a)(Na,"LocalAnnotationId",null,[]);class ua extends h.a{constructor(ta=36E5){super();this.gOa=new Map;this.K_=new Map;this.IPa=new Set;this.o2d=new za;this.pWe=ta;e.ULS.sendTraceTag(523337872,0,50,`AugmentationLoopAnnotationValidator.constructor: annotationExpirationTimeout: ${this.pWe} ms`)}dispose(){e.ULS.sendTraceTag(523337871,0,50,`AugmentationLoopAnnotationValidator.dispose: ${this.getStatus()}`);
this.IPa.clear();this.K_.clear();this.gOa.clear();super.dispose()}bpe(ta){e.ULS.sendTraceTag(521405910,0,50,"AugmentationLoopAnnotationValidator.addCoauthVersionChangedCallback");this.addHandler("CoauthVersionChanged",ta)}dUf(ta){e.ULS.sendTraceTag(521405909,0,50,"AugmentationLoopAnnotationValidator.removeCoauthVersionChangedCallback");this.removeHandler("CoauthVersionChanged",ta)}Zga(ta,wa,db){e.ULS.sendTraceTag(521405908,0,50,`AugmentationLoopAnnotationValidator.addAnnotationCallback: annotationType: ${wa}`);
this.addHandler(this.yyd(ta,wa),db);v.EwaSettings.isChangeGateEnabled("OfficeVSO:6807759_AugmentationLoopAnnotationValidatorLoggerEnabled")&&this.o2d.Roe(wa)}IJb(ta,wa,db){e.ULS.sendTraceTag(521405907,0,50,`AugmentationLoopAnnotationValidator.removeAnnotationCallback: annotationType: ${wa}`);this.removeHandler(this.yyd(ta,wa),db);v.EwaSettings.isChangeGateEnabled("OfficeVSO:6807759_AugmentationLoopAnnotationValidatorLoggerEnabled")&&this.o2d.Aej(wa)}LZi(ta,wa){e.ULS.sendTraceTag(523337870,0,50,`AugmentationLoopAnnotationValidator.onWorkbookCoauthVersionUpdate: starting, raising CoauthVersionChanged event: ${c(ta)}`);
this.raiseEvent("CoauthVersionChanged",{coauthVersion:ta,userContext:wa},this);this.rii(this.f7b);this.f7b=ta;this.a1j(this.f7b);this.Nff();e.ULS.sendTraceTag(523337869,0,50,`AugmentationLoopAnnotationValidator.onWorkbookCoauthVersionUpdate: done ${this.getStatus()}`)}BWe(ta){if(ta)try{const Pb=JSON.parse(ta);var wa=Pb.coauthVersionDocId,db=Pb.coauthVersionXluid,Jb=Pb.coauthVersionXrevId;return{DocId:"undefined"===wa?void 0:wa,Xluid:"undefined"===db?void 0:db,Xrevid:"undefined"===Jb?void 0:parseInt(Jb,
10)}}catch(Pb){e.ULS.sendTraceTag(523337868,0,10,`AugmentationLoopAnnotationValidator.extractWorkbookCoauthVersion(${ta}): Exception - ${Pb}`)}}kCd(ta,wa,db){db=this.BWe(db);void 0!==db&&(e.ULS.sendTraceTag(523337867,0,50,`AugmentationLoopAnnotationValidator.onAnnotationReceived: starting ${ta}: ${wa.operationType}: (annotation id ${wa.FM.id}) at ${c(db)}`),this.rIg({annotationType:ta,Qte:wa},db),this.Nff(),e.ULS.sendTraceTag(523337866,0,50,`AugmentationLoopAnnotationValidator.onAnnotationReceived: done ${this.getStatus()}`))}yyd(ta,
wa){return`${ta}_${wa}`}getStatus(){var ta,wa;const db=c(this.f7b),Jb=null===(ta=this.gOa)||void 0===ta?void 0:ta.size;ta=null===(wa=this.IPa)||void 0===wa?void 0:wa.size;return`current coauth version: ${db}, ${Jb} known annotations, ${ta} coauth versions on hold`}NIb(ta,wa,db,Jb){const Pb=this.gOa.get(`${wa}`);ta=this.yyd(ta,Pb.annotationType);e.ULS.sendTraceTag(523337865,0,50,`AugmentationLoopAnnotationValidator.raiseAnnotationEvent: ${db} raising ${ta} event (annotation id: ${wa})`);this.raiseEvent(ta,
Pb.Qte,this);v.EwaSettings.isChangeGateEnabled("OfficeVSO:6807759_AugmentationLoopAnnotationValidatorLoggerEnabled")&&this.o2d.qLi(Pb.annotationType,`${wa}`,Jb)}npi(ta,wa){wa=c(this.BWe(wa));ta=`${new Na(ta,wa)}`;return!this.gOa.has(ta)}rIg(ta,wa){var db=ta.Qte.FM.id;const Jb=c(wa);db=new Na(db,Jb);const Pb=`${db}`;this.gOa.has(Pb)?e.ULS.sendTraceTag(523337864,0,50,`AugmentationLoopAnnotationValidator.addNewAnnotation: ignoring duplicate annotation (annotation id ${db})`):(this.gOa.set(Pb,ta),this.K_.has(Jb)?
this.K_.get(Jb).dHa.add(db.annotationId):this.K_.set(Jb,{dHa:new Set([db.annotationId]),timestamp:Date.now()}),this.NIb("New",db,"addNewAnnotation","New"),ta=this.f7b,wa===ta||wa&&ta&&wa.DocId===ta.DocId&&wa.Xluid===ta.Xluid&&wa.Xrevid===ta.Xrevid?this.NIb("Valid",db,"addNewAnnotation","ValidOnArrival"):this.IPa.add(c(wa)))}sUf(ta){this.gOa.delete(`${ta}`);for(let [wa,db]of this.K_.entries())if(wa===ta.coauthVersion&&db.dHa.delete(ta.annotationId))break}Kfj(){Array.from(this.K_.entries()).filter(([,
ta])=>0===ta.dHa.size).forEach(([ta])=>this.K_.delete(ta))}yUf(ta){this.IPa.delete(ta)}rii(ta){var wa;const db=c(ta);(new Set(null===(wa=this.K_.get(db))||void 0===wa?void 0:wa.dHa)).forEach(Jb=>{Jb=new Na(Jb,db);this.NIb("Invalid",Jb,"invalidateAnnotations","InvalidOnCoauthVersionChanged");this.sUf(Jb)})}a1j(ta){var wa;ta=c(ta);if(this.IPa.has(ta)){var db=null===(wa=this.K_.get(ta))||void 0===wa?void 0:wa.dHa;wa=(wa=this.K_.get(ta))?Date.now()-wa.timestamp:0;for(const Jb of db)db=new Na(Jb,ta),this.NIb("Valid",
db,`validateAnnotations elapsed ${wa} ms`,"ValidAfterSomeTime");this.yUf(ta)}else e.ULS.sendTraceTag(523337863,0,50,`AugmentationLoopAnnotationValidator.validateAnnotations: ${ta} has no on-hold annotations associated with it`)}Nff(){var ta=Date.now();const wa=[],db=[];for(const Pb of this.IPa){var Jb=this.K_.get(Pb);const eb=ta-Jb.timestamp;if(eb>this.pWe)for(const Ma of Jb.dHa)Jb=new Na(Ma,Pb),this.NIb("Invalid",Jb,`invalidateExpiredAnnotations elapsed ${eb} ms`,"InvalidAfterTimeout"),wa.push(Jb)}for(const Pb of wa)this.sUf(Pb);
for(const Pb of this.IPa)ta=this.K_.get(Pb),0===(null===ta||void 0===ta?void 0:ta.dHa.size)&&db.push(Pb);for(const Pb of db)this.yUf(Pb);this.Kfj()}}Object(u.a)(ua,"AugmentationLoopAnnotationValidator",h.a,[703]);class Xa extends F.a{constructor(ta){super();this.augmentationLoopManager=null;this.$=ta;this.Fb();e.ULS.sendTraceTag(520939607,0,50,"AugmentationLoopManagerFactory.constructor: called")}create(){const ta=Date.now();f.Health.instance.recordKpiUsageForAlertableKpi("AugmentationLoopManagerCreation",
"xlalint",null);e.ULS.sendTraceTag(537170371,0,50,"AugmentationLoopManagerFactory.create: called");let wa=null;const db=[];v.EwaSettings.ma(426)&&(wa=wb.GetServiceTaskFactory.Oa(this.$.da,349,350,this.Ya),db.push(wa));Tb.TaskExtensions.za(Tb.TaskExtensions.Ed(db,this.ka,3),()=>{dc.$xi(this.$,wa?wa.result:null,this.Ya).then(Jb=>{e.ULS.sendTraceTag(537170370,0,50,"AugmentationLoopManagerFactory.create: Augmentation Loop runtime initialized");try{this.nb(this.augmentationLoopManager||(this.augmentationLoopManager=
new aa(this.$,Jb,new ua(this.$.va.AugmentationLoopAnnotationExpirationTimeoutInMs)))),dc.Guj(this.augmentationLoopManager.Soc)}catch(Pb){f.Health.instance.recordKpiFailure("AugmentationLoopManagerCreation","Exception",!1,!0,Object(b.a)(new xb.a,{extendedProperties:new Map,durationMs:Date.now()-ta})),this.nb(null),e.ULS.sendTraceTag(42796228,0,10,`AugmentationLoopManagerFactory.create: Augmentation loop initialization failed. Exception ${Pb.message}`)}}).catch(()=>{f.Health.instance.recordKpiFailure("AugmentationLoopManagerCreation",
"PromiseRejected",!1,!0,Object(b.a)(new xb.a,{extendedProperties:new Map,durationMs:Date.now()-ta}));this.nb(null);e.ULS.sendTraceTag(42796229,0,10,"AugmentationLoopManagerFactory.create: Augmentation loop initialization failed")})},this.$.ka,3)}static la(ta){e.ULS.sendTraceTag(520939606,0,50,"AugmentationLoopManagerFactory.attach: called");ta.da.Ga(327,new Xa(ta))}}Object(u.a)(Xa,"AugmentationLoopManagerFactory",F.a,[]);var ha=a(9);a=a(1161);Type.registerNamespace("_Ewa");(()=>{ha.a.Fa(ta=>{Xa.la(ta)})})();
Object(a.a)()},821:function(u,F,a){a.d(F,"g",function(){return d});a.d(F,"f",function(){return n});a.d(F,"e",function(){return m});a.d(F,"b",function(){return x});a.d(F,"d",function(){return r});a.d(F,"c",function(){return y});a.d(F,"a",function(){return v});u=a(0);var c=a(11),b=a(323),e=a(15),f=a(33);const d=(z,A,E,I)=>{e.ULS.sendTraceTag(221794372,306,20,`FormulaByExample suggestion display failure reported. Failure data ${JSON.stringify({["flowId"]:z.flowId,["originFormulaFlowId"]:z.ada.flowId,
["formulaAnonymized"]:z.anonymizedFormula,["originalFormulaAnonymized"]:z.ada.anonymizedFormula,["range"]:z.range,["failureReason"]:A})}`);E&&E.sq(z.flowId,I,{reason:A})};var h;(function(z){z.EXAMPLE="EXAMPLE";z.MODIFIEDEXAMPLE="MODIFIEDEXAMPLE";z.RESTOFRANGE="RESTOFRANGE";z.MODIFIEDRESTOFRANGE="MODIFIEDRESTOFRANGE"})(h||(h={}));Object(u.b)("suggestionCellType",h);const n=(z,A,E,I,L,V)=>{e.ULS.sendTraceTag(512350163,0,50,`Cell data didn't match suggestion output on FlowId: ${L.flowId}. cellType: ${V} caller: ${I}:
      CellData: ${B(z)}, CellFormatIndex: ${E}, SuggestionOutput: ${B(A)},
      SuggestedFormula: ${L.anonymizedFormula}}`)},m=(z,A,E)=>{try{const I=w(z,A,E);window.performance.mark(I)}catch(I){e.ULS.sendTraceTag(529109767,0,10,`FormulaByExampleTelemetryGenerator.markPerformancePoint: Error thrown : ${I.message}`)}},x=z=>{for(const A in t)try{window.performance.clearMarks(w(A,z,!1)),window.performance.clearMarks(w(A,z,!0))}catch(E){e.ULS.sendTraceTag(527005662,0,10,`FormulaByExampleTelemetryGenerator.clearPerformanceFlowMarks: Error thrown : ${E.message}`)}},r=(z,A)=>{try{return{["EditCommitToSignal"]:C(`FBE_EditCommitToSignal_${A}_${z}`,
w(t.EditCommit,A,!1),w(t.SignalSent,A,!1)),["WorkflowAndNetworkTime"]:z?0:C(`FBE_WorkflowAndNetworkTime_${A}_${z}`,w(t.SignalSent,A,!1),w(t.AnnotationReceived,A,!1)),["Calculation"]:C(`FBE_Calculation_${A}_${z}`,w(t.CalculationStart,A,z),w(t.CalculationEnd,A,z)),["ModelUpdate"]:C(`FBE_ModelUpdate_${A}_${z}`,w(t.CalculationEnd,A,z),w(t.ModelUpdated,A,z)),["PreviewRender"]:C(`FBE_PreviewRendered_${A}_${z}`,w(t.ModelUpdated,A,z),w(t.PreviewRendered,A,z)),["Total"]:C(`FBE_Total_${A}_${z}`,w(t.EditCommit,
A,!1),w(t.PreviewRendered,A,z))}}catch(E){e.ULS.sendTraceTag(529109766,0,10,`FormulaByExampleTelemetryGenerator.getPreviewShownDurations: Error thrown : ${E.message}`)}},y=(z,A)=>{try{return{["UserInPreviewDuration"]:C(`FBE_InputToPreviewRemovedWithCSE_${A}_${z}`,w(t.PreviewRendered,A,z),w(t.UserInputArrived,A,z)),["InputToPreviewRemovedWithCSE"]:C(`FBE_InputToPreviewRemovedWithCSE_${A}_${z}`,w(t.UserInputArrived,A,z),w(t.PreviewRemovedWithCSE,A,z))}}catch(E){e.ULS.sendTraceTag(529109765,0,10,`FormulaByExampleTelemetryGenerator.getPreviewRemovedDurations: Error thrown : ${E.message}`)}};
var t;(function(z){z.EditCommit="EDITCOMMIT";z.SignalSent="SIGNALSENT";z.AnnotationReceived="ANNOTATIONRECEIVED";z.CalculationStart="CALCULATIONSTART";z.CalculationEnd="CALCULATIONED";z.ModelUpdated="MODELUPDATED";z.PreviewRendered="PREVIEWRENDERED";z.UserInputArrived="USERINPUTARRIVED";z.PreviewRemovedWithCSE="PREVIEWREMOVEDWITHCSE"})(t||(t={}));Object(u.b)("FormulaByExampleFlowMarks",t);const v=z=>c.HelperMethods.R_c&&b.a.rqb&&f.a.hla(z),w=(z,A,E)=>`${z}_${A+(E?"_cached":"")}`,C=(z,A,E)=>{window.performance.measure(z,
A,E);const I=window.performance.getEntriesByName(z);if(I[I.length-1])return A=I[I.length-1].duration,performance.clearMeasures(z),A;e.ULS.sendTraceTag(526984791,0,15,`FormulaByExampleTelemetryGenerator.measureTime: could not find performance entry for measure: ${z}, startMark: ${A}, endMark: ${E}`);return-1},B=z=>z.replace(RegExp("[0-9a-zA-Z]","g"),A=>"a"<=A&&"z">=A?"a":"A"<=A&&"Z">=A?"A":"0"<=A&&"9">=A?"9":A)},851:function(u,F,a){u=a(0);var c=a(15),b=a(425),e=a(1),f=a(163),d;(function(E){E[E.UserEditedInTable=
0]="UserEditedInTable";E[E.FormulaByExampleNoTrigger=1]="FormulaByExampleNoTrigger";E[E.FlowInterrupted=2]="FlowInterrupted";E[E.FormulaByExampleFullTrigger=3]="FormulaByExampleFullTrigger";E[E.HadCachedSuggestion=4]="HadCachedSuggestion";E[E.NoCachedSuggestion=5]="NoCachedSuggestion";E[E.PreCalcPreviewRejected=6]="PreCalcPreviewRejected";E[E.WaitingForCalcResult=7]="WaitingForCalcResult";E[E.PostCalcPreviewRejected=8]="PostCalcPreviewRejected";E[E.SuggestionDidntMatch=9]="SuggestionDidntMatch";E[E.SuggestionMatched=
10]="SuggestionMatched";E[E.PreviewShouldBeShown=11]="PreviewShouldBeShown";E[E.SignalSent=12]="SignalSent";E[E.NoSignalSent=13]="NoSignalSent";E[E.AnnotationReceived=14]="AnnotationReceived";E[E.NoFormulaFound=15]="NoFormulaFound";E[E.FormulaFound=16]="FormulaFound";E[E.WorkbookClosed=17]="WorkbookClosed";E[E.UnexpectedTransition=18]="UnexpectedTransition"})(d||(d={}));Object(u.b)("FormulaByExampleFlowState",d);const h=new Map([[d.UserEditedInTable,[d.FormulaByExampleNoTrigger,d.FormulaByExampleFullTrigger]],
[d.FormulaByExampleFullTrigger,[d.FlowInterrupted,d.NoCachedSuggestion,d.HadCachedSuggestion]],[d.NoCachedSuggestion,[d.NoSignalSent,d.SignalSent]],[d.HadCachedSuggestion,[d.PreCalcPreviewRejected,d.WaitingForCalcResult]],[d.PreCalcPreviewRejected,[d.NoSignalSent,d.SignalSent]],[d.WaitingForCalcResult,[d.NoSignalSent,d.SignalSent]]]),n=new Set([d.FormulaByExampleNoTrigger,d.FlowInterrupted,d.NoSignalSent,d.SignalSent]),m=new Map([[d.PreCalcPreviewRejected,[d.SuggestionDidntMatch,d.SuggestionMatched]]]),
x=new Set([d.SuggestionDidntMatch,d.SuggestionMatched]),r=new Map([[d.WaitingForCalcResult,[d.PostCalcPreviewRejected,d.SuggestionDidntMatch,d.SuggestionMatched]],[d.SuggestionDidntMatch,[d.PostCalcPreviewRejected,d.PreviewShouldBeShown]],[d.SuggestionMatched,[d.PostCalcPreviewRejected,d.PreviewShouldBeShown]]]),y=new Set([d.PostCalcPreviewRejected,d.PreviewShouldBeShown]),t=new Map([[d.SignalSent,[d.AnnotationReceived]],[d.AnnotationReceived,[d.NoFormulaFound,d.FormulaFound]]]),v=new Set([d.NoFormulaFound,
d.FormulaFound]);class w{constructor(E,I,L){this.currentState=E;this.ZKj=I;this.yFh=L}Qua(E){const I=this.ZKj.get(this.currentState);return I&&I.includes(E)?(this.currentState=E,!0):!1}get isActive(){return!this.yFh.has(this.currentState)}ljd(){return d[this.currentState]}}Object(u.a)(w,"FormulaByExampleStateMachine",null,[]);class C{constructor(E,I,L,V,T){this.HNc=!1;this.GPi=T;this.Zqc=new w(0,h,n);this.vja={flowId:E,q5g:I,ooj:L,dgb:V,Nnc:null,JYe:!1,uRd:!1,a$f:!1,KYe:{},vBe:new Set}}get Rpi(){return this.HNc}set flowId(E){this.vja.flowId=
E}Moc(E){this.vja.vBe.add(E)}Qua(E,I){17===E?this.jH():(this.K9b(E,I),this.hPg())}jH(){this.GPi(this.vja)}K9b(E,I){var L,V;this.Zqc.Qua(E)?this.OUi(E):(null===(L=this.Tqb)||void 0===L?0:L.Qua(E))?this.dMi(E):(null===(V=this.gAc)||void 0===V?0:V.Qua(E))?this.yXi(E,I):this.XSi(E,I);(E=this.B4e(E))&&this.Jpe(E,I)}OUi(E){switch(E){case 2:this.vja.JYe=!0;break;case 6:this.Tqb=new w(E,m,x);break;case 7:this.Tqb=new w(E,r,y);break;case 12:this.HNc=!0,this.vja.a$f=!0,this.gAc=new w(E,t,v)}}dMi(E){switch(E){case 9:this.vja.uRd=
!1;break;case 10:this.vja.uRd=!0}}yXi(E,I){switch(E){case 14:this.HNc=!1;break;case 16:this.vja.Nnc=I?I.Nnc:null}}XSi(E,I){this.Jpe(this.B4e(18),{reason:`${`Tried to change state from ${this.ptj()} to ${d[E]}`}.${this.o6e(I)}`});this.jH()}hPg(){var E,I;this.Zqc.isActive||(null===(E=this.Tqb)||void 0===E?0:E.isActive)||(null===(I=this.gAc)||void 0===I?0:I.isActive)||this.jH()}Jpe(E,I){if(I=this.o6e(I))E.explanation||(E.explanation=""),E.explanation+=I;I=E.name;E=Object(f.d)(E,["name"]);this.vja.KYe[I]=
E}o6e(E){return null!=E&&null!=E.reason?" "+E.reason:""}ptj(){var E,I;const L=`OriginStateMachine: ${this.Zqc.isActive?this.Zqc.ljd():"NotActive"}`,V=`CalcStateMachine: ${(null===(E=this.Tqb)||void 0===E?0:E.isActive)?this.Tqb.ljd():"NotActive"}`;E=`SignalStateMachine: ${(null===(I=this.gAc)||void 0===I?0:I.isActive)?this.gAc.ljd():"NotActive"}`;return`[${L}, ${V}, ${E}]`}B4e(E){switch(E){case 1:return this.vU("FBEFullTrigger",!1);case 3:return this.vU("FBEFullTrigger",!0);case 5:return this.vU("CachedSuggestion",
!1);case 4:return this.vU("CachedSuggestion",!0);case 6:return this.vU("PreviewShouldBeShown",!1,"Before calling calc evaluation");case 8:return this.vU("PreviewShouldBeShown",!1,"After returning from Calc");case 9:return this.vU("SetCellMatchedSuggestion",!1);case 10:return this.vU("SetCellMatchedSuggestion",!0);case 11:return this.vU("PreviewShouldBeShown",!0);case 8:return this.vU("PreviewShouldBeShown",!1,"After returning from Calc");case 15:return this.vU("FormulaFound",!1);case 16:return this.vU("FormulaFound",
!0);case 18:return this.vU("UnexpectedTransition",!0)}return null}vU(E,I,L){return L?{name:E,value:I,explanation:L}:{name:E,value:I}}}Object(u.a)(C,"FormulaByExampleFlowDataAggregator",null,[]);a.d(F,"b",function(){return-1});a.d(F,"a",function(){return B});class B{static getInstance(E){this.instance||(e.EwaSettings.isChangeGateEnabled("OfficeVSO:7041480_FormulaByExampleFlowAggregatorFixed")?this.instance=z.getInstance(E):this.instance=A.getInstance(E));return this.instance}}Object(u.a)(B,"FormulaByExampleFlowsTrackerFactory",
null,[]);class z{constructor(E){this.nextId=1;this.Gff=this.NPb=0;this.Oaa=new Map;this.AYd=new Map;this.BEe=new Map;this.yc=()=>{const I=this.cZh();if(0!==I.size){this.$.sendBeaconTraceTag(526984790,50,!1,`some pending FBE flows were not resolved by workbook closure. Total flows amount in sessions: ${this.NPb}, Unresolved flows amount: ${I.size}, pending flows: ${[...I].join()}, interrupted flows amount ${this.Gff}`);for(const L of I)this.sq(L,17)}};this.vMj=I=>{const L=I.flowId;var V=I.q5g;const T=
I.ooj,H=I.dgb,D=I.Nnc,G=I.JYe,J=I.uRd,M=I.a$f,Q=I.KYe,U=I.vBe,Z=this.t5e(V);I=Z.lpf;const P=I!==D;P&&(Z.Wbg++,Z.lpf=D);J&&Z.vOe++;G&&this.Gff++;M&&this.NPb++;V={["flowId"]:L,["columnKey"]:V,["rowNumber"]:T,["triggerCommand"]:Object(b.a)(H),["flowDataAggergation"]:Q,["editOperationsInColumn"]:Z.nOe,["suggestionChangesInColumn"]:Z.Wbg,["gotNewSuggestion"]:P,["matchedSuggestionsInColumn"]:Z.vOe,["cellCycleColumns"]:Array.from(U).sort(),["rowsEditedInColumn"]:Array.from(Z.tOe).sort()};c.ULS.sendTraceTag(512365781,
0,null!=I||null!=D?20:50,`FormulaByExampleFlowsTracker.summarizeFlowOverallData: Flow Aggregation results: ${JSON.stringify(V)}`);this.Oaa.delete(L)};this.$=E;this.$.Xj(this.yc)}static getInstance(E){z.instance||(z.instance=new z(E));return z.instance}U4e(){const E=this.nextId++,I=this.Oaa.get(-1);I?(I.flowId=E,this.Oaa.set(E,I),this.Oaa.delete(-1)):c.ULS.sendTraceTag(512503829,0,15,`FormulaByExampleFlowsTracker.getNewFlowId: on flowId ${E} called getNewFlowId without having matched anonymousFlow`);
return E}PBf(E,I,L,V){this.sq(-1,2);this.Oaa.delete(-1);I=this.bQh(I,L);L=this.t5e(I);L.nOe++;L.tOe.add(V);this.Oaa.set(-1,new C(-1,I,V,E,this.vMj))}Moc(E,I){const L=this.Oaa.get(E);L?L.Moc(I):c.ULS.sendTraceTag(512258585,0,15,`FormulaByExampleFlowsTracker.onCellCycleFound: on flowId ${E}
          called onCellCycleFound without having matched flow`)}sq(E,I,L){if(this.Oaa.has(E)){var V=this.Oaa.get(E);V?V.Qua(I,L):c.ULS.sendTraceTag(512503828,0,10,`FormulaByExampleFlowsTracker.enterFlowToNewState: on flowId ${E} flowIdsToAggregatorsMap.has returned true but flowIdsToAggregatorsMap.get didn't find the wanted aggregator object`)}}bQh(E,I){let L=this.AYd.get(E);void 0===L&&(L=this.AYd.size,this.AYd.set(E,L));return L+"_"+I}cZh(){const E=new Set;for(const [I,L]of this.Oaa)L.Rpi&&E.add(I);
return E}t5e(E){let I=this.BEe.get(E);I||(I={nOe:0,vOe:0,Wbg:0,lpf:null,tOe:new Set},this.BEe.set(E,I));return I}}Object(u.a)(z,"FormulaByExampleFlowsTracker",null,[252]);class A{constructor(E){this.nextId=1;this.Sac=new Set;this.NPb=0;this.yc=()=>{let I=this.Sac.size;0!==I&&this.$.sendBeaconTraceTag(526984790,50,!1,"some pending FBE flows were not resolved by workbook closure. Total flows amount in sessions: {0}, Unresolved flows amount: {1}, pending flows: {2}",this.NPb,I,[...this.Sac].join())};
this.$=E;this.$.Xj(this.yc)}static getInstance(E){A.instance||(A.instance=new A(E));return A.instance}PBf(){}Moc(){}sq(E,I){switch(I){case 12:this.Ivj(E);break;case 14:this.Jvj(E)}}U4e(){return this.nextId++}Ivj(E){this.Sac.add(E);this.NPb++}Jvj(E){this.Sac.delete(E)}}Object(u.a)(A,"FormulaByExampleFlowsTrackerDeprecated",null,[252])},868:function(u,F,a){a.d(F,"a",function(){return 2})}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaDSEsNext.augmentationloop.js.map/fe9b4911e30abbd231bca7dba9a151c5/EwaDSEsNext.augmentationloop.js.map